<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…’ç«¥è‹±æ–‡æ‹¼å­—å­¸ç¿’æ©Ÿ (Pro Plus) ğŸ</title>
    <style>
        /* --- ğŸ¨ è¦–è¦ºè¨­è¨ˆ --- */
        :root {
            --primary-yellow: #FFD700;
            --primary-blue: #40E0D0;
            --text-dark: #2C3E50;
            --bg-color: #F7F9FC;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.1);
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            
            /* æ–‡å­—é¡è‰²å®šç¾© */
            --color-vowel: #FF4500;       /* ç´…è‰²ï¼šçŸ­æ¯éŸ³/ä¸€èˆ¬æ¯éŸ³ */
            --color-consonant: #1E90FF;   /* è—è‰²ï¼šå­éŸ³ */
            --color-irregular: #9932CC;   /* ç´«è‰²ï¼šä¸è¦å‰‡/é•·æ¯éŸ³/ç‰¹æ®Šç™¼éŸ³/ä¸ç™¼éŸ³å­—æ¯ */
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
            text-align: center;
        }

        h1 {
            color: #FF8C00;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px #FFE4B5;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: 5px solid var(--primary-yellow);
        }

        /* --- ğŸ›ï¸ æ§åˆ¶åˆ— --- */
        .controls-bar {
            background-color: #E0F7FA;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        select {
            padding: 10px 15px;
            font-size: 1rem;
            border-radius: 10px;
            border: 2px solid var(--primary-blue);
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        label { font-weight: bold; color: #00796B; }

        /* --- ğŸ“‘ åˆ†é ç±¤ --- */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #ddd;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 4px solid transparent;
            margin-bottom: -3px;
        }

        .tab-btn:hover { color: var(--primary-blue); }
        .tab-btn.active {
            color: var(--text-dark);
            border-bottom: 4px solid var(--primary-yellow);
        }

        /* --- ğŸ« å­¸ç¿’å€åŸŸ --- */
        .mode-section {
            display: none;
            animation: fadeIn 0.5s;
        }
        .mode-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .word-card {
            padding: 30px;
            background: #FFF9C4;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .big-word {
            font-size: 4rem;
            font-weight: bold;
            margin: 10px 0;
            letter-spacing: 2px;
        }

        /* å­—å…ƒé¡è‰²æ¨£å¼ */
        .char-vowel { color: var(--color-vowel); }
        .char-consonant { color: var(--color-consonant); }
        .char-irregular { color: var(--color-irregular); font-weight: 900; text-shadow: 1px 1px 0px #eee; }

        .info-text {
            font-size: 1.5rem;
            margin: 10px 0;
            color: #555;
        }
        
        .example-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .example-text {
            font-style: italic;
            color: #555;
            font-size: 1.2rem;
        }

        /* ä¾‹å¥æ’­æ”¾æŒ‰éˆ• */
        .btn-sm-speak {
            background: #FF6B6B;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .btn-sm-speak:active { transform: scale(0.9); }

        .syllable-box {
            background: white;
            display: block; /* é è¨­é¡¯ç¤º */
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px dashed #aaa;
            margin: 15px auto;
            font-size: 1.2rem;
            color: #666;
            width: fit-content;
        }

        /* --- ğŸ® äº’å‹•æŒ‰éˆ• --- */
        button.action-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #008B8B;
            transition: transform 0.1s;
            margin: 5px;
        }
        button.action-btn:active { transform: translateY(4px); box-shadow: none; }
        button.secondary-btn { background-color: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; }
        button.speak-btn { background-color: #FF8C00; box-shadow: 0 4px 0 #D2691E; font-size: 1.5rem; padding: 15px 30px; }

        /* --- ğŸ§© ç©æœ¨èˆ‡è½å¯« --- */
        .letter-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            min-height: 60px;
        }
        .letter-block {
            background: white;
            border: 3px solid var(--primary-yellow);
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 0 #ccc;
            user-select: none;
        }
        .answer-area {
            min-height: 60px;
            border-bottom: 4px solid #333;
            margin: 0 20px;
            display: flex;
            justify-content: center;
            gap: 5px;
            font-size: 3rem;
            font-family: monospace;
        }
        input[type="text"] {
            font-size: 2rem;
            padding: 10px;
            width: 80%;
            text-align: center;
            border: 3px solid var(--primary-blue);
            border-radius: 15px;
            outline: none;
            margin-bottom: 15px;
        }
        .feedback-msg {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 15px;
            min-height: 1.5em;
        }
        .correct { color: #2ecc71; }
        .wrong { color: #e74c3c; }

        /* --- âŒ¨ï¸ è™›æ“¬éµç›¤æ¨£å¼ (æ–°å¢) --- */
        .keyboard-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            align-items: center;
        }
        .keyboard-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .key-btn {
            background: white;
            border: 1px solid #ccc;
            border-bottom: 3px solid #bbb;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            user-select: none;
            min-width: 30px;
            transition: all 0.1s;
        }
        .key-btn:active {
            transform: translateY(2px);
            border-bottom: 1px solid #bbb;
            background: #f0f0f0;
        }
        .key-special {
            background: #eee;
            font-size: 1rem;
            padding: 10px 10px;
        }
        .key-space {
            width: 150px;
        }

        @media (max-width: 600px) {
            .big-word { font-size: 3rem; }
            .controls-bar { flex-direction: column; }
            select { width: 100%; }
            .key-btn { padding: 8px 6px; font-size: 1.1rem; min-width: 25px; } /* æ‰‹æ©Ÿç‰ˆéµç›¤ç¸®å° */
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1>ğŸ æ‹¼å­—å°èœœèœ‚ Pro+</h1>

    <div class="controls-bar">
        <div>
            <label>ğŸ“š ç­‰ç´šï¼š</label>
            <select id="levelSelect" onchange="changeLevel()"></select>
        </div>
        <div>
            <label>ğŸ—£ï¸ ç™¼éŸ³ï¼š</label>
            <select id="voiceSelect">
                <option value="">æ­£åœ¨è¼‰å…¥èªéŸ³...</option>
            </select>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('modeA')">ğŸ‘€ çœ‹å–®å­— (å­¸ç¿’)</button>
        <button class="tab-btn" onclick="switchTab('modeB')">ğŸ§© æ‹¼ç©æœ¨ (ç·´ç¿’)</button>
        <button class="tab-btn" onclick="switchTab('modeC')">ğŸ“ è½å¯«è€ƒ (æ¸¬é©—)</button>
    </div>

    <div id="modeA" class="mode-section active">
        <div class="word-card">
            <button class="action-btn speak-btn" onclick="speakText(currentWordObj.word)">ğŸ”Š å–®å­—ç™¼éŸ³</button>
            
            <div id="wordDisplay" class="big-word"></div>
            
            <div id="chineseDisplay" class="info-text"></div>
            
            <div class="example-container">
                <div id="exampleDisplay" class="example-text"></div>
                <button class="btn-sm-speak" onclick="speakText(currentWordObj.example)" title="æœ—è®€ä¾‹å¥">ğŸ”ˆ</button>
            </div>
            
            <div id="syllableBox" class="syllable-box"></div>
            <div style="margin-top: 10px;">
                <button id="btnToggleSyllable" class="action-btn secondary-btn" style="font-size: 1rem; padding: 8px 16px;" onclick="toggleSyllables()">éš±è—éŸ³ç¯€</button>
            </div>
        </div>
        <button class="action-btn" onclick="nextWord()">â¡ï¸ ä¸‹ä¸€å€‹å–®å­—</button>
    </div>

    <div id="modeB" class="mode-section">
        <div class="word-card">
            <button class="action-btn speak-btn" onclick="speakText(currentWordObj.word)">ğŸ”Š æ’­è²éŸ³</button>
            <div class="info-text" id="chineseHintB"></div>
            
            <div id="puzzleAnswer" class="answer-area"></div>
            <div id="puzzlePieces" class="letter-container"></div>
            <div id="feedbackB" class="feedback-msg"></div>
        </div>
        <button class="action-btn secondary-btn" onclick="resetPuzzle()">ğŸ”„ é‡ç½®</button>
        <button class="action-btn" onclick="nextWord()">â¡ï¸ ä¸‹ä¸€å€‹å–®å­—</button>
    </div>

    <div id="modeC" class="mode-section">
        <div class="word-card">
            <button class="action-btn speak-btn" onclick="speakText(currentWordObj.word)">ğŸ”Š æ’­è²éŸ³</button>
            <div class="info-text" id="chineseHintC"></div>
            
            <input type="text" id="dictationInput" placeholder="é»æ“ŠæŒ‰éˆ•æˆ–æ‰“å­—..." autocomplete="off">
            
            <div id="virtualKeyboard" class="keyboard-area"></div>

            <div id="feedbackC" class="feedback-msg"></div>
        </div>
        <button class="action-btn secondary-btn" onclick="checkDictation()">âœ… æª¢æŸ¥ç­”æ¡ˆ</button>
        <button class="action-btn" onclick="nextWord()">â¡ï¸ ä¸‹ä¸€å€‹å–®å­—</button>
    </div>

</div>

<script>
    // --- 1. è³‡æ–™ä¾†æº (Data Source) ---
    // irregularIndices: æ¨™ç¤ºç‚ºç´«è‰²çš„ç´¢å¼•ä½ç½® (å¾ 0 é–‹å§‹)
    const rawData = [
        // --- åŸå§‹å–®å­— ---
        { word: "cube", syllables: ["cube"], chinese: "ç«‹æ–¹é«”", example: "The toy is shaped like a cube.", irregularIndices: [1, 3] },
        { word: "cute", syllables: ["cute"], chinese: "å¯æ„›çš„", example: "The puppy is very cute.", irregularIndices: [1, 3] },
        { word: "mule", syllables: ["mule"], chinese: "é¨¾å­", example: "The farmer uses a mule to carry supplies.", irregularIndices: [1, 3] },
        { word: "flute", syllables: ["flute"], chinese: "é•·ç¬›", example: "She plays the flute every day.", irregularIndices: [2, 4] },
        { word: "ruler", syllables: ["ru", "ler"], chinese: "å°ºï¼›çµ±æ²»è€…", example: "Please use a ruler to draw a straight line.", irregularIndices: [1] },
        { word: "tube", syllables: ["tube"], chinese: "ç®¡å­", example: "Water flows through the tube.", irregularIndices: [1, 3] },
        { word: "tune", syllables: ["tune"], chinese: "æ—‹å¾‹ï¼›èª¿éŸ³", example: "This tune is easy to sing.", irregularIndices: [1, 3] },
        { word: "again", syllables: ["a", "gain"], chinese: "å†æ¬¡", example: "Please try again.", irregularIndices: [2, 3] },
        { word: "cold", syllables: ["cold"], chinese: "å†·çš„", example: "The water is very cold.", irregularIndices: [1] },
        { word: "hot", syllables: ["hot"], chinese: "ç†±çš„", example: "Be careful, the soup is hot.", irregularIndices: [] },
        { word: "where", syllables: ["where"], chinese: "åœ¨å“ªè£¡", example: "Where are you going?", irregularIndices: [2, 4] },
        { word: "went away", syllables: ["went", "a", "way"], chinese: "é›¢é–‹ï¼›èµ°æ‰", example: "He went away quickly." },
        { word: "take", syllables: ["take"], chinese: "æ‹¿ï¼›å¸¶èµ°", example: "Please take your bag with you.", irregularIndices: [1, 3] },
        { word: "night", syllables: ["night"], chinese: "å¤œæ™š", example: "The stars are bright at night.", irregularIndices: [1, 2, 3] },
        { word: "at", syllables: ["at"], chinese: "åœ¨â€¦", example: "She is at home.", irregularIndices: [] },
        { word: "they", syllables: ["they"], chinese: "ä»–å€‘", example: "They are playing outside.", irregularIndices: [2, 3] },
        { word: "me", syllables: ["me"], chinese: "æˆ‘ï¼ˆå—æ ¼ï¼‰", example: "Please give the book to me.", irregularIndices: [1] },
        // --- æ–°å¢å–®å­—æ¸…å–® (Yçµå°¾ã€ç‰‡èªã€å¸¸è¦‹å­—) ---
    { word: "too", syllables: ["too"], chinese: "ä¹Ÿï¼›å¤ª", example: "I like ice cream too.", irregularIndices: [1, 2] },
    { word: "ran up", syllables: ["ran", " ", "up"], chinese: "è·‘å‘...ï¼›è·‘ä¸Šå»", example: "The dog ran up the hill.", irregularIndices: [] },
    { word: "ran out", syllables: ["ran", " ", "out"], chinese: "è·‘å‡ºå»ï¼›ç”¨å®Œ", example: "They ran out of milk.", irregularIndices: [4, 5] },
    { word: "ball", syllables: ["ball"], chinese: "çƒ", example: "He kicked the ball.", irregularIndices: [1] },
    { word: "get", syllables: ["get"], chinese: "å¾—åˆ°", example: "Did you get my email?", irregularIndices: [] },
    { word: "are", syllables: ["are"], chinese: "æ˜¯ï¼ˆè¤‡æ•¸/ç¬¬äºŒäººç¨±ï¼‰", example: "You are my best friend.", irregularIndices: [0, 1, 2] },
    { word: "little", syllables: ["lit", "tle"], chinese: "å°çš„", example: "I saw a little bird.", irregularIndices: [4, 5] },
    { word: "get out", syllables: ["get", " ", "out"], chinese: "é›¢é–‹ï¼›å‡ºå»", example: "Please get out of the car.", irregularIndices: [4, 5] },
    { word: "her", syllables: ["her"], chinese: "å¥¹çš„", example: "This is her bag.", irregularIndices: [1, 2] },
    { word: "squirrel", syllables: ["squir", "rel"], chinese: "æ¾é¼ ", example: "The squirrel is eating a nut.", irregularIndices: [3, 4] },
    { word: "live", syllables: ["live"], chinese: "å±…ä½", example: "I live in a big city.", irregularIndices: [3] },
    { word: "that", syllables: ["that"], chinese: "é‚£å€‹", example: "Look at that bird!", irregularIndices: [] },
    { word: "say", syllables: ["say"], chinese: "èªª", example: "What did you say?", irregularIndices: [1, 2] },
    { word: "car", syllables: ["car"], chinese: "è»Šå­", example: "My dad drives a red car.", irregularIndices: [1, 2] },
    { word: "goodbye", syllables: ["good", "bye"], chinese: "å†è¦‹", example: "He waved goodbye to his friends.", irregularIndices: [1, 2, 5, 6] },
    { word: "your", syllables: ["your"], chinese: "ä½ çš„", example: "What is your name?", irregularIndices: [1, 2, 3] },
    
    // --- Y ç•¶æ¯éŸ³ç³»åˆ— (/i/ sound) ---
    { word: "baby", syllables: ["ba", "by"], chinese: "å¬°å…’", example: "The baby is sleeping.", irregularIndices: [1, 3] },
    { word: "city", syllables: ["cit", "y"], chinese: "åŸå¸‚", example: "New York is a big city.", irregularIndices: [3] },
    { word: "jelly", syllables: ["jel", "ly"], chinese: "æœå‡", example: "I like peanut butter and jelly.", irregularIndices: [4] },
    { word: "lady", syllables: ["la", "dy"], chinese: "å¥³å£«", example: "A nice lady helped me.", irregularIndices: [1, 3] },
    { word: "pony", syllables: ["po", "ny"], chinese: "å°é¦¬", example: "She rode a pony at the farm.", irregularIndices: [1, 3] },
    { word: "twenty", syllables: ["twen", "ty"], chinese: "äºŒå", example: "I have twenty dollars.", irregularIndices: [5] },
    
    // --- Y ç•¶æ¯éŸ³ç³»åˆ— (/ai/ sound) ---
    { word: "cry", syllables: ["cry"], chinese: "å“­æ³£", example: "Don't cry, it's okay.", irregularIndices: [2] },
    { word: "dry", syllables: ["dry"], chinese: "ä¹¾çš„", example: "Is your shirt dry yet?", irregularIndices: [2] },
    { word: "fly", syllables: ["fly"], chinese: "é£›ï¼›è’¼è …", example: "Birds can fly high.", irregularIndices: [2] },
    { word: "fry", syllables: ["fry"], chinese: "æ²¹ç‚¸", example: "Let's fry some eggs.", irregularIndices: [2] },
    { word: "sky", syllables: ["sky"], chinese: "å¤©ç©º", example: "The sky is blue today.", irregularIndices: [2] },
    
    // --- å…¶ä»–æ··åˆå–®å­— ---
    { word: "meow", syllables: ["me", "ow"], chinese: "å–µ (è²“å«è²)", example: "The cat said meow.", irregularIndices: [1, 2, 3] },
    { word: "running", syllables: ["run", "ning"], chinese: "è·‘æ­¥ä¸­", example: "He is running fast.", irregularIndices: [] },
    { word: "string", syllables: ["string"], chinese: "ç¹©å­", example: "Tie the box with a string.", irregularIndices: [] },
    { word: "tent", syllables: ["tent"], chinese: "å¸³ç¯·", example: "We slept in a tent.", irregularIndices: [] },
    { word: "ran", syllables: ["ran"], chinese: "è·‘ (runçš„éå»å¼)", example: "He ran to the bus stop.", irregularIndices: [] },
    { word: "come", syllables: ["come"], chinese: "ä¾†", example: "Please come here.", irregularIndices: [1, 3] },
    { word: "walk", syllables: ["walk"], chinese: "èµ°è·¯", example: "I walk to school.", irregularIndices: [1, 2] },
    { word: "home", syllables: ["home"], chinese: "å®¶", example: "Let's go home.", irregularIndices: [1, 3] },
    { word: "am", syllables: ["am"], chinese: "æ˜¯ (ç¬¬ä¸€äººç¨±)", example: "I am happy.", irregularIndices: [] }

    ];

    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentLevelWords = [];
    let currentWordIndex = 0;
    let currentWordObj = null;
    let voices = [];
    let synth = window.speechSynthesis;
    let isSyllableVisible = true;

    // --- 2. åˆå§‹åŒ–èˆ‡è¨­å®š ---
    window.onload = function() {
        initLevelSystem();
        initVoiceSystem();
        initKeyboard(); // åˆå§‹åŒ–è™›æ“¬éµç›¤
        loadWord(0);
    };

    function initLevelSystem() {
        const levelSelect = document.getElementById('levelSelect');
        const totalWords = rawData.length;
        const levelSize = 10;
        const totalLevels = Math.ceil(totalWords / levelSize);

        for (let i = 0; i < totalLevels; i++) {
            let option = document.createElement('option');
            option.value = i;
            option.text = `Level ${i + 1} (${i * levelSize + 1} - ${Math.min((i + 1) * levelSize, totalWords)})`;
            levelSelect.appendChild(option);
        }
        
        let allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.text = "å…¨éƒ¨å–®å­— (All)";
        levelSelect.appendChild(allOption);

        changeLevel();
    }

    function changeLevel() {
        const val = document.getElementById('levelSelect').value;
        if (val === 'all') {
            currentLevelWords = [...rawData];
        } else {
            const levelIndex = parseInt(val);
            const start = levelIndex * 10;
            const end = start + 10;
            currentLevelWords = rawData.slice(start, end);
        }
        currentWordIndex = 0;
        loadWord(0);
    }

    function initVoiceSystem() {
        const voiceSelect = document.getElementById('voiceSelect');
        
        const populateVoices = () => {
            voices = synth.getVoices();
            if (voices.length === 0) {
                voiceSelect.innerHTML = '<option value="">ç­‰å¾…èªéŸ³è¼‰å…¥...</option>';
                return;
            }

            voiceSelect.innerHTML = '';
            let bestVoiceIndex = 0; 
            let bestPriority = 0;

            voices.forEach((voice, index) => {
                let option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = index;
                voiceSelect.appendChild(option);

                let currentPriority = 0;
                if (voice.lang.startsWith('en')) {
                    currentPriority = 1;
                    if (voice.lang === 'en-US' || voice.lang === 'en_US') currentPriority += 2;
                    if (voice.name.includes('Siri')) currentPriority += 10;
                    else if (voice.name === 'Samantha') currentPriority += 9;
                    else if (voice.name === 'Aaron') currentPriority += 8;
                    else if (voice.name.includes('Google US English')) currentPriority += 7;
                }

                if (currentPriority > bestPriority) {
                    bestPriority = currentPriority;
                    bestVoiceIndex = index;
                }
            });

            if (voices.length > 0) voiceSelect.selectedIndex = bestVoiceIndex;
        };

        if (speechSynthesis.onvoiceschanged !== undefined) {
             speechSynthesis.onvoiceschanged = populateVoices;
        }
        populateVoices();
        setTimeout(populateVoices, 500);
        setTimeout(populateVoices, 1000);
    }

    function speakText(text) {
        if (!text) return;
        synth.cancel();
        const utterThis = new SpeechSynthesisUtterance(text);
        const voiceSelect = document.getElementById('voiceSelect');
        if (voices.length > 0 && voiceSelect.value) {
            utterThis.voice = voices[voiceSelect.value];
        }
        utterThis.rate = 0.85;
        synth.speak(utterThis);
    }

    // --- âŒ¨ï¸ è™›æ“¬éµç›¤é‚è¼¯ (æ–°åŠŸèƒ½) ---
    function initKeyboard() {
        const keyboardContainer = document.getElementById('virtualKeyboard');
        // QWERTY æ’åˆ—
        const rows = [
            ["q","w","e","r","t","y","u","i","o","p"],
            ["a","s","d","f","g","h","j","k","l"],
            ["z","x","c","v","b","n","m"]
        ];

        rows.forEach(rowKeys => {
            let rowDiv = document.createElement('div');
            rowDiv.className = 'keyboard-row';
            rowKeys.forEach(char => {
                let btn = document.createElement('button');
                btn.className = 'key-btn';
                btn.innerText = char;
                btn.onclick = () => typeKey(char);
                rowDiv.appendChild(btn);
            });
            keyboardContainer.appendChild(rowDiv);
        });

        // å¢åŠ åŠŸèƒ½éµè¡Œ (ç©ºç™½èˆ‡å€’é€€)
        let funcRow = document.createElement('div');
        funcRow.className = 'keyboard-row';
        
        // ç©ºç™½éµ
        let spaceBtn = document.createElement('button');
        spaceBtn.className = 'key-btn key-special key-space';
        spaceBtn.innerText = 'Space (ç©ºç™½)';
        spaceBtn.onclick = () => typeKey(' ');
        funcRow.appendChild(spaceBtn);

        // åˆªé™¤éµ
        let backBtn = document.createElement('button');
        backBtn.className = 'key-btn key-special';
        backBtn.innerText = 'âŒ«';
        backBtn.onclick = () => backspaceKey();
        funcRow.appendChild(backBtn);

        keyboardContainer.appendChild(funcRow);
    }

    function typeKey(char) {
        const input = document.getElementById('dictationInput');
        input.value += char;
        input.focus(); // ä¿æŒç„¦é»æ–¹ä¾¿ç¹¼çºŒè¼¸å…¥
    }

    function backspaceKey() {
        const input = document.getElementById('dictationInput');
        input.value = input.value.slice(0, -1);
        input.focus();
    }

    // --- 3. æ ¸å¿ƒé‚è¼¯ ---
    function loadWord(index) {
        if (index >= currentLevelWords.length) index = 0;
        currentWordIndex = index;
        currentWordObj = currentLevelWords[index];

        document.getElementById('feedbackB').innerText = "";
        document.getElementById('feedbackC').innerText = "";
        document.getElementById('dictationInput').value = "";

        // Mode A
        renderColoredWord(currentWordObj);
        document.getElementById('chineseDisplay').innerText = currentWordObj.chinese;
        document.getElementById('exampleDisplay').innerText = currentWordObj.example;
        document.getElementById('syllableBox').innerText = currentWordObj.syllables.join(" - ");
        updateSyllableVisibility();

        // Mode B & C Text
        document.getElementById('chineseHintB').innerText = currentWordObj.chinese;
        document.getElementById('chineseHintC').innerText = currentWordObj.chinese;

        // Mode B Setup
        initPuzzleMode(currentWordObj.word);
    }

    function nextWord() {
        currentWordIndex++;
        if (currentWordIndex >= currentLevelWords.length) currentWordIndex = 0;
        loadWord(currentWordIndex);
        speakText(currentWordObj.word);
    }

    function switchTab(modeId) {
        document.querySelectorAll('.mode-section').forEach(el => el.classList.remove('active'));
        document.getElementById(modeId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function renderColoredWord(wordObj) {
        const display = document.getElementById('wordDisplay');
        display.innerHTML = '';
        const vowels = ['a','e','i','o','u'];
        const word = wordObj.word;
        const irregulars = wordObj.irregularIndices || [];

        for (let i = 0; i < word.length; i++) {
            let char = word[i];
            let span = document.createElement('span');
            span.innerText = char;

            if (irregulars.includes(i)) {
                span.className = 'char-irregular';
            } else if (vowels.includes(char.toLowerCase())) {
                span.className = 'char-vowel';
            } else {
                span.className = 'char-consonant';
            }
            display.appendChild(span);
        }
    }

    function toggleSyllables() {
        isSyllableVisible = !isSyllableVisible;
        updateSyllableVisibility();
    }

    function updateSyllableVisibility() {
        const box = document.getElementById('syllableBox');
        const btn = document.getElementById('btnToggleSyllable');
        if (isSyllableVisible) {
            box.style.display = 'inline-block';
            btn.innerText = 'éš±è—éŸ³ç¯€';
        } else {
            box.style.display = 'none';
            btn.innerText = 'é¡¯ç¤ºéŸ³ç¯€';
        }
    }

    // --- Mode B: ç©æœ¨é‚è¼¯ ---
    let puzzleCurrentAnswer = [];
    function initPuzzleMode(word) {
        const container = document.getElementById('puzzlePieces');
        const answerArea = document.getElementById('puzzleAnswer');
        container.innerHTML = '';
        answerArea.innerHTML = '';
        puzzleCurrentAnswer = [];

        let letters = word.split('').sort(() => Math.random() - 0.5);

        letters.forEach((char) => {
            let btn = document.createElement('div');
            btn.className = 'letter-block';
            btn.innerText = char;
            btn.onclick = () => {
                let ansSpan = document.createElement('span');
                ansSpan.innerText = char;
                answerArea.appendChild(ansSpan);
                puzzleCurrentAnswer.push(char);
                btn.style.visibility = 'hidden';
                checkPuzzle(word);
            };
            container.appendChild(btn);
        });
    }

    function resetPuzzle() {
        initPuzzleMode(currentWordObj.word);
        document.getElementById('feedbackB').innerText = "";
    }

    function checkPuzzle(correctWord) {
        const userWord = puzzleCurrentAnswer.join('');
        if (userWord.length === correctWord.length) {
            const feedback = document.getElementById('feedbackB');
            if (userWord === correctWord) {
                feedback.innerHTML = "<span class='correct'>ğŸ‰ ç­”å°äº†ï¼</span>";
                speakText(correctWord);
            } else {
                feedback.innerHTML = "<span class='wrong'>âŒ å†è©¦ä¸€æ¬¡ï¼</span>";
            }
        }
    }

    // --- Mode C: è½å¯«é‚è¼¯ ---
    function checkDictation() {
        const input = document.getElementById('dictationInput');
        const feedback = document.getElementById('feedbackC');
        
        if (input.value.trim().toLowerCase() === currentWordObj.word.toLowerCase()) {
            feedback.innerHTML = "<span class='correct'>ğŸŒŸ å®Œå…¨æ­£ç¢ºï¼</span>";
            speakText(currentWordObj.word);
        } else {
            feedback.innerHTML = `<span class='wrong'>âŒ æ­£ç¢ºæ˜¯ï¼š${currentWordObj.word}</span>`;
        }
    }
</script>

</body>
</html>

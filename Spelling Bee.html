<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…’ç«¥è‹±æ–‡æ‹¼å­—å­¸ç¿’æ©Ÿ (Weekly Edition Pro) ğŸ</title>
    <style>
        /* --- ğŸ¨ è¦–è¦ºè¨­è¨ˆ --- */
        :root {
            --primary-yellow: #FFD700;
            --primary-blue: #40E0D0;
            --text-dark: #2C3E50;
            --bg-color: #F7F9FC;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.1);
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            
            /* æ–‡å­—é¡è‰²å®šç¾© */
            --color-vowel: #FF4500;       /* ç´…è‰²ï¼šçŸ­æ¯éŸ³/ä¸€èˆ¬æ¯éŸ³ */
            --color-consonant: #1E90FF;   /* è—è‰²ï¼šå­éŸ³ */
            --color-irregular: #9932CC;   /* ç´«è‰²ï¼šä¸è¦å‰‡/é•·æ¯éŸ³/ç‰¹æ®Šç™¼éŸ³ */
            --color-symbol: #888888;      /* ç°è‰²ï¼šæ¨™é»ç¬¦è™Ÿ */
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
            text-align: center;
            touch-action: manipulation; 
        }

        h1 {
            color: #FF8C00;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px #FFE4B5;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: 5px solid var(--primary-yellow);
        }

        /* --- ğŸ›ï¸ æ§åˆ¶åˆ— --- */
        .controls-bar {
            background-color: #E0F7FA;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        select {
            padding: 10px 15px;
            font-size: 1rem;
            border-radius: 10px;
            border: 2px solid var(--primary-blue);
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        label { font-weight: bold; color: #00796B; }

        /* --- ğŸ“‘ åˆ†é ç±¤ --- */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #ddd;
            flex-wrap: wrap; /* æ‰‹æ©Ÿç‰ˆè‡ªå‹•æ›è¡Œ */
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 15px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 4px solid transparent;
            margin-bottom: -3px;
        }

        .tab-btn:hover { color: var(--primary-blue); }
        .tab-btn.active {
            color: var(--text-dark);
            border-bottom: 4px solid var(--primary-yellow);
        }

        /* --- ğŸ« å­¸ç¿’å€åŸŸ --- */
        .mode-section {
            display: none;
            animation: fadeIn 0.5s;
        }
        .mode-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .word-card {
            padding: 30px;
            background: #FFF9C4;
            border-radius: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .big-word {
            font-size: 4rem;
            font-weight: bold;
            margin: 10px 0;
            letter-spacing: 2px;
        }

        /* å­—å…ƒé¡è‰²æ¨£å¼ */
        .char-vowel { color: var(--color-vowel); }
        .char-consonant { color: var(--color-consonant); }
        .char-irregular { color: var(--color-irregular); font-weight: 900; text-shadow: 1px 1px 0px #eee; }
        .char-symbol { color: var(--color-symbol); font-weight: normal; } /* æ–°å¢ç¬¦è™Ÿæ¨£å¼ */

        .info-text {
            font-size: 1.5rem;
            margin: 10px 0;
            color: #555;
        }
        
        .example-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .example-text {
            font-style: italic;
            color: #555;
            font-size: 1.2rem;
        }

        .btn-sm-speak {
            background: #FF6B6B;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .btn-sm-speak:active { transform: scale(0.9); }

        .syllable-box {
            background: white;
            display: block; 
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px dashed #aaa;
            margin: 15px auto;
            font-size: 1.2rem;
            color: #666;
            width: fit-content;
        }

        /* --- ğŸ® äº’å‹•æŒ‰éˆ• --- */
        button.action-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #008B8B;
            transition: transform 0.1s;
            margin: 5px;
        }
        button.action-btn:active { transform: translateY(4px); box-shadow: none; }
        button.secondary-btn { background-color: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; }
        button.speak-btn { background-color: #FF8C00; box-shadow: 0 4px 0 #D2691E; font-size: 1.5rem; padding: 15px 30px; }
        
        /* å°èˆªæŒ‰éˆ•ç¾¤çµ„ */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* --- ğŸ“‹ å–®å­—ç¸½è¦½åˆ—è¡¨ --- */
        .word-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .list-btn {
            background: white;
            border: 2px solid var(--primary-blue);
            padding: 10px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
        }
        .list-btn:hover {
            background: #E0F7FA;
            transform: translateY(-2px);
        }
        .list-btn.active-word {
            background: var(--primary-yellow);
            border-color: #FF8C00;
            font-weight: bold;
        }

        /* --- ğŸ§© ç©æœ¨èˆ‡è½å¯« --- */
        .letter-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            min-height: 60px;
        }
        .letter-block {
            background: white;
            border: 3px solid var(--primary-yellow);
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 0 #ccc;
            user-select: none;
        }
        .letter-block.space-block {
            border: 2px dashed #ccc;
            background: #f0f0f0;
            width: 30px;
        }

        .answer-area {
            min-height: 60px;
            border-bottom: 4px solid #333;
            margin: 0 20px;
            display: flex;
            justify-content: center;
            gap: 5px;
            font-size: 3rem;
            font-family: monospace;
            flex-wrap: wrap;
        }
        .answer-area span {
             min-width: 20px;
        }

        input[type="text"] {
            font-size: 2rem;
            padding: 10px;
            width: 80%;
            text-align: center;
            border: 3px solid var(--primary-blue);
            border-radius: 15px;
            outline: none;
            margin-bottom: 15px;
        }
        .feedback-msg {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 15px;
            min-height: 1.5em;
        }
        .correct { color: #2ecc71; }
        .wrong { color: #e74c3c; }

        /* --- âŒ¨ï¸ è™›æ“¬éµç›¤æ¨£å¼ --- */
        .keyboard-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            align-items: center;
        }
        .keyboard-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .key-btn {
            background: white;
            border: 1px solid #ccc;
            border-bottom: 3px solid #bbb;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            user-select: none;
            min-width: 30px;
            transition: all 0.1s;
        }
        .key-btn:active {
            transform: translateY(2px);
            border-bottom: 1px solid #bbb;
            background: #f0f0f0;
        }
        .key-special {
            background: #eee;
            font-size: 1rem;
            padding: 10px 10px;
        }
        .key-space {
            width: 150px;
        }

        @media (max-width: 600px) {
            .big-word { font-size: 3rem; }
            .controls-bar { flex-direction: column; }
            select { width: 100%; }
            .key-btn { padding: 8px 6px; font-size: 1.1rem; min-width: 25px; } 
            .nav-buttons { flex-direction: column; gap: 5px; }
            button.action-btn { width: 100%; margin: 5px 0; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1>ğŸ æ‹¼å­—å°èœœèœ‚ Weekly</h1>

    <div class="controls-bar">
        <div>
            <label>ğŸ“… é€²åº¦ï¼š</label>
            <select id="levelSelect" onchange="changeLevel()"></select>
        </div>
        <div>
            <label>ğŸ—£ï¸ ç™¼éŸ³ï¼š</label>
            <select id="voiceSelect">
                <option value="">æ­£åœ¨è¼‰å…¥èªéŸ³...</option>
            </select>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('modeA')">ğŸ‘€ çœ‹å–®å­—</button>
        <button class="tab-btn" onclick="switchTab('modeB')">ğŸ§© æ‹¼ç©æœ¨</button>
        <button class="tab-btn" onclick="switchTab('modeC')">ğŸ“ è½å¯«è€ƒ</button>
        <button class="tab-btn" onclick="switchTab('modeList')">ğŸ“‹ å–®å­—è¡¨</button>
    </div>

    <div id="modeA" class="mode-section active">
        <div class="word-card">
            <button class="action-btn speak-btn" onclick="speakText(currentWordObj.word)">ğŸ”Š å–®å­—ç™¼éŸ³</button>
            <div id="wordDisplay" class="big-word"></div>
            <div id="chineseDisplay" class="info-text"></div>
            <div class="example-container">
                <div id="exampleDisplay" class="example-text"></div>
                <button class="btn-sm-speak" onclick="speakText(currentWordObj.example)" title="æœ—è®€ä¾‹å¥">ğŸ”ˆ</button>
            </div>
            <div id="syllableBox" class="syllable-box"></div>
            <div style="margin-top: 10px;">
                <button id="btnToggleSyllable" class="action-btn secondary-btn" style="font-size: 1rem; padding: 8px 16px;" onclick="toggleSyllables()">éš±è—éŸ³ç¯€</button>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="action-btn secondary-btn" onclick="prevWord()">â¬…ï¸ ä¸Šä¸€å€‹</button>
            <button class="action-btn" onclick="nextWord()">ä¸‹ä¸€å€‹ â¡ï¸</button>
        </div>
    </div>

    <div id="modeB" class="mode-section">
        <div class="word-card">
            <button class="action-btn speak-btn" onclick="speakText(currentWordObj.word)">ğŸ”Š æ’­è²éŸ³</button>
            <div class="info-text" id="chineseHintB"></div>
            <div id="puzzleAnswer" class="answer-area"></div>
            <div id="puzzlePieces" class="letter-container"></div>
            <div id="feedbackB" class="feedback-msg"></div>
        </div>
        <div class="nav-buttons">
             <button class="action-btn secondary-btn" onclick="resetPuzzle()">ğŸ”„ é‡ç½®</button>
             <button class="action-btn secondary-btn" onclick="prevWord()">â¬…ï¸ ä¸Šä¸€å€‹</button>
             <button class="action-btn" onclick="nextWord()">ä¸‹ä¸€å€‹ â¡ï¸</button>
        </div>
    </div>

    <div id="modeC" class="mode-section">
        <div class="word-card">
            <button class="action-btn speak-btn" onclick="speakText(currentWordObj.word)">ğŸ”Š æ’­è²éŸ³</button>
            <div class="info-text" id="chineseHintC"></div>
            <input type="text" id="dictationInput" placeholder="é»æ“ŠæŒ‰éˆ•æˆ–æ‰“å­—..." autocomplete="off">
            <div id="virtualKeyboard" class="keyboard-area"></div>
            <div id="feedbackC" class="feedback-msg"></div>
        </div>
        
        <div style="margin-top: 15px;">
            <button class="action-btn secondary-btn" onclick="resetDictation()">ğŸ”„ æ¸…é™¤é‡å¯«</button>
            <button class="action-btn" onclick="checkDictation()">âœ… æª¢æŸ¥ç­”æ¡ˆ</button>
        </div>
        <div class="nav-buttons">
            <button class="action-btn secondary-btn" onclick="prevWord()">â¬…ï¸ ä¸Šä¸€å€‹</button>
            <button class="action-btn" style="background-color: #333;" onclick="nextWord()">ä¸‹ä¸€å€‹ â¡ï¸</button>
        </div>
    </div>

    <div id="modeList" class="mode-section">
        <div class="word-card" style="background: white; border: 2px solid #eee;">
            <h2>æœ¬é€±å–®å­—åˆ—è¡¨</h2>
            <div id="fullWordList" class="word-list-grid"></div>
        </div>
    </div>

</div>

<script>
    // --- 1. è³‡æ–™ä¾†æº (Data Source) ---
    const rawData = [
        // --- Week 13: Long U & Magic E ---
        { week: "13", word: "cube", syllables: ["cube"], chinese: "ç«‹æ–¹é«”", example: "The ice is a cube.", irregularIndices: [1, 3] },
        { week: "13", word: "cute", syllables: ["cute"], chinese: "å¯æ„›çš„", example: "That puppy is so cute.", irregularIndices: [1, 3] },
        { week: "13", word: "mule", syllables: ["mule"], chinese: "é¨¾å­", example: "A mule is very strong.", irregularIndices: [1, 3] },
        { week: "13", word: "flute", syllables: ["flute"], chinese: "é•·ç¬›", example: "She plays the flute.", irregularIndices: [2, 4] },
        { week: "13", word: "ruler", syllables: ["rul", "er"], chinese: "å°º", example: "Use a ruler to measure.", irregularIndices: [1] },
        { week: "13", word: "tube", syllables: ["tube"], chinese: "ç®¡å­", example: "Water flows in the tube.", irregularIndices: [1, 3] },
        { week: "13", word: "tune", syllables: ["tune"], chinese: "æ›²èª¿", example: "Whistle a happy tune.", irregularIndices: [1, 3] },
        { week: "13", word: "again", syllables: ["a", "gain"], chinese: "å†ä¸€æ¬¡", example: "Can we play again?", irregularIndices: [2, 3] },
        { week: "13", word: "cold", syllables: ["cold"], chinese: "å¯’å†·çš„", example: "It is cold in winter.", irregularIndices: [1] },
        { week: "13", word: "hot", syllables: ["hot"], chinese: "ç†±çš„", example: "The soup is hot.", irregularIndices: [] },
        { week: "13", word: "where", syllables: ["where"], chinese: "åœ¨å“ªè£¡", example: "Where is my book?", irregularIndices: [2, 4] },
        { week: "13", word: "went away", syllables: ["went", " ", "a", "way"], chinese: "é›¢é–‹äº†", example: "The bird went away.", irregularIndices: [] },
        { week: "13", word: "take", syllables: ["take"], chinese: "æ‹¿å–", example: "Please take one.", irregularIndices: [1, 3] },
        { week: "13", word: "night", syllables: ["night"], chinese: "å¤œæ™š", example: "Good night, sleep tight.", irregularIndices: [1, 2, 3] },
        { week: "13", word: "at", syllables: ["at"], chinese: "åœ¨...", example: "Look at the stars.", irregularIndices: [] },
        { week: "13", word: "they", syllables: ["they"], chinese: "ä»–å€‘", example: "They are my friends.", irregularIndices: [2, 3] },
        { week: "13", word: "me", syllables: ["me"], chinese: "æˆ‘(å—æ ¼)", example: "Give it to me.", irregularIndices: [1] },

        // --- Week 14: Phrases & Position ---
        { week: "14", word: "next", syllables: ["next"], chinese: "ä¸‹ä¸€å€‹", example: "Who is next?", irregularIndices: [] },
        { week: "14", word: "too", syllables: ["too"], chinese: "ä¹Ÿï¼›å¤ª", example: "It is too hot.", irregularIndices: [1, 2] },
        { week: "14", word: "ran up", syllables: ["ran", " ", "up"], chinese: "è·‘å‘ï¼›è·‘ä¸Šå»", example: "He ran up the hill.", irregularIndices: [] },
        { week: "14", word: "ran out", syllables: ["ran", " ", "out"], chinese: "è·‘å‡ºå»ï¼›ç”¨å®Œ", example: "We ran out of milk.", irregularIndices: [4, 5] },
        { week: "14", word: "where", syllables: ["where"], chinese: "åœ¨å“ªè£¡", example: "Where are you?", irregularIndices: [2, 4] },
        { week: "14", word: "ball", syllables: ["ball"], chinese: "çƒ", example: "Kick the ball.", irregularIndices: [1] },
        { week: "14", word: "get", syllables: ["get"], chinese: "å¾—åˆ°", example: "Go get the ball.", irregularIndices: [] },
        { week: "14", word: "are", syllables: ["are"], chinese: "æ˜¯(è¤‡æ•¸)", example: "We are happy.", irregularIndices: [0, 1, 2] },
        { week: "14", word: "little", syllables: ["lit", "tle"], chinese: "å°çš„", example: "I have a little cat.", irregularIndices: [4, 5] },

        // --- Week 15: Nature & Questions ---
        { week: "15", word: "get out", syllables: ["get", " ", "out"], chinese: "å‡ºå»ï¼›æ‹¿å‡º", example: "Get out your pencil.", irregularIndices: [4, 5] },
        { week: "15", word: "her", syllables: ["her"], chinese: "å¥¹çš„", example: "That is her bag.", irregularIndices: [1, 2] },
        { week: "15", word: "squirrel", syllables: ["squir", "rel"], chinese: "æ¾é¼ ", example: "The squirrel eats nuts.", irregularIndices: [3, 4] },
        { week: "15", word: "live", syllables: ["live"], chinese: "å±…ä½", example: "I live in a house.", irregularIndices: [3] },
        { week: "15", word: "that", syllables: ["that"], chinese: "é‚£å€‹", example: "What is that?", irregularIndices: [] },
        { week: "15", word: "where", syllables: ["where"], chinese: "åœ¨å“ªè£¡", example: "Where do you live?", irregularIndices: [2, 4] },
        { week: "15", word: "say", syllables: ["say"], chinese: "èªª", example: "What did you say?", irregularIndices: [1, 2] },
        { week: "15", word: "too", syllables: ["too"], chinese: "ä¹Ÿ", example: "I want to go too.", irregularIndices: [1, 2] },
        { week: "15", word: "car", syllables: ["car"], chinese: "æ±½è»Š", example: "My dad drives a car.", irregularIndices: [1, 2] },
        { week: "15", word: "goodbye", syllables: ["good", "bye"], chinese: "å†è¦‹", example: "Say goodbye to teacher.", irregularIndices: [1, 2, 5, 6] },
        { week: "15", word: "your", syllables: ["your"], chinese: "ä½ çš„", example: "Is this your book?", irregularIndices: [1, 2, 3] },

        // --- Week 16: Y as Vowel & Suffixes (-ed, -ing) ---
        { week: "16", word: "baby", syllables: ["ba", "by"], chinese: "å¬°å…’", example: "The baby is crying.", irregularIndices: [1, 3] },
        { week: "16", word: "city", syllables: ["cit", "y"], chinese: "åŸå¸‚", example: "Taipei is a big city.", irregularIndices: [3] },
        { week: "16", word: "jelly", syllables: ["jel", "ly"], chinese: "æœå‡", example: "I like grape jelly.", irregularIndices: [4] },
        { week: "16", word: "lady", syllables: ["la", "dy"], chinese: "å¥³å£«", example: "She is a nice lady.", irregularIndices: [1, 3] },
        { week: "16", word: "pony", syllables: ["po", "ny"], chinese: "å°é¦¬", example: "I rode a pony.", irregularIndices: [1, 3] },
        { week: "16", word: "twenty", syllables: ["twen", "ty"], chinese: "äºŒå", example: "I have twenty dollars.", irregularIndices: [5] },
        { week: "16", word: "cry", syllables: ["cry"], chinese: "å“­", example: "Don't cry.", irregularIndices: [2] },
        { week: "16", word: "dry", syllables: ["dry"], chinese: "ä¹¾çš„", example: "Keep your feet dry.", irregularIndices: [2] },
        { week: "16", word: "fly", syllables: ["fly"], chinese: "é£›", example: "Birds can fly.", irregularIndices: [2] },
        { week: "16", word: "fry", syllables: ["fry"], chinese: "æ²¹ç‚¸", example: "Let's fry an egg.", irregularIndices: [2] },
        { week: "16", word: "sky", syllables: ["sky"], chinese: "å¤©ç©º", example: "The sky is blue.", irregularIndices: [2] },
        { week: "16", word: "helped", syllables: ["helped"], chinese: "å¹«å¿™(éå»å¼)", example: "He helped his mom.", irregularIndices: [4, 5] },
        { week: "16", word: "helping", syllables: ["help", "ing"], chinese: "æ­£åœ¨å¹«å¿™", example: "She is helping me.", irregularIndices: [] },
        { week: "16", word: "jumped", syllables: ["jumped"], chinese: "è·³(éå»å¼)", example: "The frog jumped.", irregularIndices: [4, 5] },
        { week: "16", word: "jumping", syllables: ["jump", "ing"], chinese: "æ­£åœ¨è·³", example: "He is jumping high.", irregularIndices: [] },
        { week: "16", word: "looked", syllables: ["looked"], chinese: "çœ‹(éå»å¼)", example: "She looked at the picture.", irregularIndices: [1, 2, 4, 5] },
        { week: "16", word: "looking", syllables: ["look", "ing"], chinese: "æ­£åœ¨çœ‹", example: "What are you looking at?", irregularIndices: [1, 2] },
        { week: "16", word: "passed", syllables: ["passed"], chinese: "ç¶“é/é€šé(éå»å¼)", example: "He passed the ball.", irregularIndices: [4, 5] },
        { week: "16", word: "passing", syllables: ["pass", "ing"], chinese: "æ­£åœ¨ç¶“é", example: "Time is passing fast.", irregularIndices: [] },
        { week: "16", word: "tossed", syllables: ["tossed"], chinese: "æ‹‹/æŠ•(éå»å¼)", example: "He tossed the coin.", irregularIndices: [4, 5] },
        { week: "16", word: "tossing", syllables: ["toss", "ing"], chinese: "æ­£åœ¨æ‹‹", example: "They are tossing the ball.", irregularIndices: [] },
        { week: "16", word: "worked", syllables: ["worked"], chinese: "å·¥ä½œ(éå»å¼)", example: "Dad worked late.", irregularIndices: [4, 5] },
        { week: "16", word: "working", syllables: ["work", "ing"], chinese: "æ­£åœ¨å·¥ä½œ", example: "I am working hard.", irregularIndices: [] },
        { week: "16", word: "cleaned", syllables: ["cleaned"], chinese: "æ‰“æƒ(éå»å¼)", example: "I cleaned my room.", irregularIndices: [2, 3, 5, 6] },
        { week: "16", word: "cleaning", syllables: ["clean", "ing"], chinese: "æ­£åœ¨æ‰“æƒ", example: "Mom is cleaning.", irregularIndices: [2, 3] },
        { week: "16", word: "stayed", syllables: ["stayed"], chinese: "åœç•™(éå»å¼)", example: "We stayed home.", irregularIndices: [2, 3, 4, 5] },
        { week: "16", word: "staying", syllables: ["stay", "ing"], chinese: "æ­£åœ¨åœç•™", example: "Are you staying here?", irregularIndices: [2, 3] },
        { week: "16", word: "waited", syllables: ["wait", "ed"], chinese: "ç­‰å¾…(éå»å¼)", example: "We waited for the bus.", irregularIndices: [1, 2] },
        { week: "16", word: "waiting", syllables: ["wait", "ing"], chinese: "æ­£åœ¨ç­‰", example: "I am waiting for you.", irregularIndices: [1, 2] },
        { week: "16", word: "wanted", syllables: ["want", "ed"], chinese: "æƒ³è¦(éå»å¼)", example: "She wanted a doll.", irregularIndices: [] },
        { week: "16", word: "wanting", syllables: ["want", "ing"], chinese: "æ­£æƒ³è¦", example: "He is wanting some water.", irregularIndices: [] },
        { week: "16", word: "meow", syllables: ["me", "ow"], chinese: "å–µ(è²“å«è²)", example: "The cat says meow.", irregularIndices: [1, 2, 3] },
        { week: "16", word: "running", syllables: ["run", "ning"], chinese: "è·‘æ­¥", example: "Running is fun.", irregularIndices: [] },
        { week: "16", word: "string", syllables: ["string"], chinese: "ç¹©å­", example: "Tie it with string.", irregularIndices: [] },
        { week: "16", word: "tent", syllables: ["tent"], chinese: "å¸³ç¯·", example: "We sleep in a tent.", irregularIndices: [] },
        { week: "16", word: "ran", syllables: ["ran"], chinese: "è·‘(éå»å¼)", example: "The dog ran fast.", irregularIndices: [] },
        { week: "16", word: "come", syllables: ["come"], chinese: "ä¾†", example: "Come here.", irregularIndices: [1, 3] },
        { week: "16", word: "walk", syllables: ["walk"], chinese: "èµ°è·¯", example: "Let's walk together.", irregularIndices: [1, 2] },
        { week: "16", word: "home", syllables: ["home"], chinese: "å®¶", example: "Go home.", irregularIndices: [1, 3] },
        { week: "16", word: "am", syllables: ["am"], chinese: "æ˜¯(ç¬¬ä¸€äººç¨±)", example: "I am a student.", irregularIndices: [] },

        // --- Week 17: Plurals (-s, -es) ---
        { week: "17", word: "cans", syllables: ["cans"], chinese: "ç½å­(è¤‡æ•¸)", example: "Two cans of soda.", irregularIndices: [] },
        { week: "17", word: "hats", syllables: ["hats"], chinese: "å¸½å­(è¤‡æ•¸)", example: "Red hats are nice.", irregularIndices: [] },
        { week: "17", word: "tops", syllables: ["tops"], chinese: "ä¸Šè¡£/é™€èº(è¤‡æ•¸)", example: "Spinning tops.", irregularIndices: [] },
        { week: "17", word: "trees", syllables: ["trees"], chinese: "æ¨¹(è¤‡æ•¸)", example: "Green trees.", irregularIndices: [2, 3] },
        { week: "17", word: "axes", syllables: ["ax", "es"], chinese: "æ–§é ­(è¤‡æ•¸)", example: "Woodcutters use axes.", irregularIndices: [] },
        { week: "17", word: "buses", syllables: ["bus", "es"], chinese: "å…¬è»Š(è¤‡æ•¸)", example: "School buses are yellow.", irregularIndices: [] },
        { week: "17", word: "dishes", syllables: ["dish", "es"], chinese: "ç›¤å­(è¤‡æ•¸)", example: "Wash the dishes.", irregularIndices: [2, 3] },
        { week: "17", word: "dresses", syllables: ["dress", "es"], chinese: "æ´‹è£(è¤‡æ•¸)", example: "Pretty dresses.", irregularIndices: [] },
        { week: "17", word: "inches", syllables: ["inch", "es"], chinese: "è‹±å‹(è¤‡æ•¸)", example: "Twelve inches make a foot.", irregularIndices: [2, 3] },
        { week: "17", word: "lunches", syllables: ["lunch", "es"], chinese: "åˆé¤(è¤‡æ•¸)", example: "Pack the lunches.", irregularIndices: [3, 4] },
        { week: "17", word: "mixes", syllables: ["mix", "es"], chinese: "æ··åˆ(è¤‡æ•¸)", example: "She mixes the paint.", irregularIndices: [] },
        { week: "17", word: "wishes", syllables: ["wish", "es"], chinese: "é¡˜æœ›(è¤‡æ•¸)", example: "Make three wishes.", irregularIndices: [2, 3] },
        { week: "17", word: "around", syllables: ["a", "round"], chinese: "åœ¨å‘¨åœ", example: "Turn around.", irregularIndices: [2, 3] },
        { week: "17", word: "ball", syllables: ["ball"], chinese: "çƒ", example: "Catch the ball.", irregularIndices: [1] },
        { week: "17", word: "kite", syllables: ["kite"], chinese: "é¢¨ç®", example: "Fly a kite.", irregularIndices: [1, 3] },
        { week: "17", word: "way", syllables: ["way"], chinese: "é“è·¯/æ–¹å¼", example: "Which way to go?", irregularIndices: [1, 2] },
        { week: "17", word: "faster", syllables: ["fas", "ter"], chinese: "æ›´å¿«", example: "Run faster!", irregularIndices: [] },
        { week: "17", word: "pretty", syllables: ["pret", "ty"], chinese: "æ¼‚äº®çš„", example: "A pretty flower.", irregularIndices: [1, 4, 5] },
        { week: "17", word: "yellow", syllables: ["yel", "low"], chinese: "é»ƒè‰²", example: "A yellow banana.", irregularIndices: [3, 4, 5] },
        { week: "17", word: "look", syllables: ["look"], chinese: "çœ‹", example: "Look at me.", irregularIndices: [1, 2] },
        { week: "17", word: "picture", syllables: ["pic", "ture"], chinese: "åœ–ç‰‡", example: "Draw a picture.", irregularIndices: [3, 4, 5, 6] },
        { week: "17", word: "ride", syllables: ["ride"], chinese: "é¨/æ­ä¹˜", example: "Ride a bike.", irregularIndices: [1, 3] },

        // --- Week 18: Contractions ---
        { week: "18", word: "aren't", syllables: ["aren't"], chinese: "ä¸æ˜¯ (are not)", example: "We aren't late.", irregularIndices: [3, 4, 5] },
        { week: "18", word: "doesn't", syllables: ["does", "n't"], chinese: "ä¸ (does not)", example: "He doesn't know.", irregularIndices: [1, 2, 5, 6] },
        { week: "18", word: "didn't", syllables: ["did", "n't"], chinese: "æ²’æœ‰ (did not)", example: "I didn't do it.", irregularIndices: [4, 5] },
        { week: "18", word: "hasn't", syllables: ["has", "n't"], chinese: "é‚„æ²’ (has not)", example: "She hasn't eaten.", irregularIndices: [4, 5] },
        { week: "18", word: "isn't", syllables: ["is", "n't"], chinese: "ä¸æ˜¯ (is not)", example: "It isn't raining.", irregularIndices: [3, 4] },
        { week: "18", word: "haven't", syllables: ["have", "n't"], chinese: "é‚„æ²’ (have not)", example: "I haven't seen him.", irregularIndices: [5, 6] },
        { week: "18", word: "he's", syllables: ["he's"], chinese: "ä»–æ˜¯ (he is)", example: "He's my brother.", irregularIndices: [2, 3] },
        { week: "18", word: "i'm", syllables: ["i'm"], chinese: "æˆ‘æ˜¯ (I am)", example: "I'm happy.", irregularIndices: [1, 2] },
        { week: "18", word: "it's", syllables: ["it's"], chinese: "å®ƒæ˜¯ (it is)", example: "It's a cat.", irregularIndices: [2, 3] },
        { week: "18", word: "she's", syllables: ["she's"], chinese: "å¥¹æ˜¯ (she is)", example: "She's tall.", irregularIndices: [3, 4] },
        { week: "18", word: "wasn't", syllables: ["was", "n't"], chinese: "ä¸æ˜¯ (was not)", example: "He wasn't there.", irregularIndices: [4, 5] },
        { week: "18", word: "coming", syllables: ["com", "ing"], chinese: "æ­£åœ¨ä¾†", example: "The bus is coming.", irregularIndices: [1] },
        { week: "18", word: "look up", syllables: ["look", " ", "up"], chinese: "æŸ¥é–±ï¼›å‘ä¸Šçœ‹", example: "Look up the word.", irregularIndices: [1, 2] },
        { week: "18", word: "look out", syllables: ["look", " ", "out"], chinese: "å°å¿ƒï¼›å‘å¤–çœ‹", example: "Look out for cars!", irregularIndices: [1, 2, 5, 6] },
        { week: "18", word: "bee", syllables: ["bee"], chinese: "èœœèœ‚", example: "A busy bee.", irregularIndices: [1, 2] },
        { week: "18", word: "here", syllables: ["here"], chinese: "é€™è£¡", example: "Come here.", irregularIndices: [1, 3] },
        { week: "18", word: "when", syllables: ["when"], chinese: "ä½•æ™‚", example: "When is lunch?", irregularIndices: [2] },
        { week: "18", word: "does", syllables: ["does"], chinese: "åš/åŠ©å‹•è©", example: "Does he like it?", irregularIndices: [1, 2] },
        { week: "18", word: "put", syllables: ["put"], chinese: "æ”¾ç½®", example: "Put it down.", irregularIndices: [1] },
        { week: "18", word: "came", syllables: ["came"], chinese: "ä¾† (comeéå»å¼)", example: "He came yesterday.", irregularIndices: [1, 3] },
        
        // --- Week 19: Long Vowels Review & More ---
        { week: "19", word: "kite", syllables: ["kite"], chinese: "é¢¨ç®", example: "Fly a kite.", irregularIndices: [1, 3] },
        { week: "19", word: "ruler", syllables: ["rul", "er"], chinese: "å°º", example: "I have a ruler.", irregularIndices: [1] },
        { week: "19", word: "twenty", syllables: ["twen", "ty"], chinese: "äºŒå", example: "Count to twenty.", irregularIndices: [5] },
        { week: "19", word: "nine", syllables: ["nine"], chinese: "ä¹", example: "Number nine.", irregularIndices: [1, 3] },
        { week: "19", word: "robe", syllables: ["robe"], chinese: "é•·è¢/æµ´è¢", example: "Wear a robe.", irregularIndices: [1, 3] },
        { week: "19", word: "fire", syllables: ["fire"], chinese: "ç«", example: "The fire is hot.", irregularIndices: [1, 3] },
        { week: "19", word: "cute", syllables: ["cute"], chinese: "å¯æ„›çš„", example: "A cute baby.", irregularIndices: [1, 3] },
        { week: "19", word: "hose", syllables: ["hose"], chinese: "æ°´ç®¡", example: "Water the garden with a hose.", irregularIndices: [1, 3] },
        { week: "19", word: "tune", syllables: ["tune"], chinese: "æ›²èª¿", example: "Sing a tune.", irregularIndices: [1, 3] },
        { week: "19", word: "bike", syllables: ["bike"], chinese: "è…³è¸è»Š", example: "Ride a bike.", irregularIndices: [1, 3] },
        { week: "19", word: "hive", syllables: ["hive"], chinese: "èœ‚çª©", example: "Bees live in a hive.", irregularIndices: [1, 3] },
        { week: "19", word: "map", syllables: ["map"], chinese: "åœ°åœ–", example: "Look at the map.", irregularIndices: [] },
        { week: "19", word: "cut", syllables: ["cut"], chinese: "åˆ‡/å‰ª", example: "Cut the paper.", irregularIndices: [] },
        { week: "19", word: "hole", syllables: ["hole"], chinese: "æ´", example: "Dig a hole.", irregularIndices: [1, 3] },
        { week: "19", word: "dive", syllables: ["dive"], chinese: "æ½›æ°´/è·³æ°´", example: "Dive into the pool.", irregularIndices: [1, 3] },
        { week: "19", word: "cone", syllables: ["cone"], chinese: "åœ“éŒé«”/ç”œç­’", example: "Ice cream cone.", irregularIndices: [1, 3] },
        { week: "19", word: "top", syllables: ["top"], chinese: "é ‚ç«¯/é™€èº", example: "Spin the top.", irregularIndices: [] },
        { week: "19", word: "tube", syllables: ["tube"], chinese: "ç®¡å­", example: "A plastic tube.", irregularIndices: [1, 3] },
        { week: "19", word: "gate", syllables: ["gate"], chinese: "å¤§é–€", example: "Open the gate.", irregularIndices: [1, 3] },
        { week: "19", word: "mule", syllables: ["mule"], chinese: "é¨¾å­", example: "The mule is stubborn.", irregularIndices: [1, 3] },
        { week: "19", word: "tape", syllables: ["tape"], chinese: "è† å¸¶", example: "Use some tape.", irregularIndices: [1, 3] },
        { week: "19", word: "vine", syllables: ["vine"], chinese: "è—¤è”“", example: "Grapes grow on a vine.", irregularIndices: [1, 3] },
        { week: "19", word: "ride", syllables: ["ride"], chinese: "é¨", example: "Ride a horse.", irregularIndices: [1, 3] },
        { week: "19", word: "rope", syllables: ["rope"], chinese: "ç¹©å­", example: "Jump rope.", irregularIndices: [1, 3] },
        { week: "19", word: "cage", syllables: ["cage"], chinese: "ç± å­", example: "The bird is in a cage.", irregularIndices: [1, 3] },
        { week: "19", word: "flute", syllables: ["flute"], chinese: "é•·ç¬›", example: "Play the flute.", irregularIndices: [2, 4] },
        { week: "19", word: "poke", syllables: ["poke"], chinese: "æˆ³", example: "Don't poke me.", irregularIndices: [1, 3] },
        { week: "19", word: "tire", syllables: ["tire"], chinese: "è¼ªèƒ", example: "A flat tire.", irregularIndices: [1, 3] },
        { week: "19", word: "net", syllables: ["net"], chinese: "ç¶²å­", example: "Catch fish with a net.", irregularIndices: [] },
        { week: "19", word: "nose", syllables: ["nose"], chinese: "é¼»å­", example: "Touch your nose.", irregularIndices: [1, 3] },
        { week: "19", word: "short", syllables: ["short"], chinese: "çŸ­çš„/çŸ®çš„", example: "He is short.", irregularIndices: [2, 3] },
        { week: "19", word: "old", syllables: ["old"], chinese: "è€çš„/èˆŠçš„", example: "An old book.", irregularIndices: [0] },
        { week: "19", word: "fat", syllables: ["fat"], chinese: "èƒ–çš„", example: "A fat cat.", irregularIndices: [] },
        { week: "19", word: "thin", syllables: ["thin"], chinese: "ç˜¦çš„/è–„çš„", example: "The book is thin.", irregularIndices: [] },
        { week: "19", word: "hot", syllables: ["hot"], chinese: "ç†±çš„", example: "It is hot today.", irregularIndices: [] },
        { week: "19", word: "tall", syllables: ["tall"], chinese: "é«˜çš„", example: "A tall tree.", irregularIndices: [1] },
        { week: "19", word: "young", syllables: ["young"], chinese: "å¹´è¼•çš„", example: "She is young.", irregularIndices: [1, 2] },
        { week: "19", word: "on", syllables: ["on"], chinese: "åœ¨...ä¸Šé¢", example: "It is on the table.", irregularIndices: [] },
        { week: "19", word: "under", syllables: ["un", "der"], chinese: "åœ¨...ä¸‹é¢", example: "Under the chair.", irregularIndices: [3, 4] },
        { week: "19", word: "in", syllables: ["in"], chinese: "åœ¨...è£¡é¢", example: "In the box.", irregularIndices: [] }
    ];

    // --- 2. å…¨åŸŸè®Šæ•¸ ---
    let currentLevelWords = [];
    let currentWordIndex = 0;
    let currentWordObj = null;
    let voices = [];
    let synth = window.speechSynthesis;
    let isSyllableVisible = true;
    let audioCtx = null;

    // --- 3. åˆå§‹åŒ–èˆ‡è¨­å®š ---
    window.onload = function() {
        initLevelSystem();
        initVoiceSystem();
        initKeyboard(); 
        initAudio();
    };

    // --- éŸ³æ•ˆç³»çµ± ---
    function initAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
            audioCtx = new AudioContext();
        }
    }

    function playSound(type) {
        if (!audioCtx) initAudio();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'correct') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        } else {
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- Helper: é™£åˆ—æ´—ç‰Œ (Shuffle) ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- ä¾æ“š Week ä¾†å»ºç«‹é¸å–® ---
    function initLevelSystem() {
        const levelSelect = document.getElementById('levelSelect');
        const weeks = [...new Set(rawData.map(item => item.week))].sort();

        weeks.forEach(wk => {
            let option = document.createElement('option');
            option.value = wk;
            option.text = `ğŸ“… Week ${wk}`;
            levelSelect.appendChild(option);
        });
        
        let allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.text = "ğŸ“š å…¨éƒ¨è¤‡ç¿’ (All Weeks)";
        levelSelect.appendChild(allOption);

        changeLevel();
    }

    function changeLevel() {
        const val = document.getElementById('levelSelect').value;
        if (val === 'all') {
            currentLevelWords = [...rawData];
        } else {
            currentLevelWords = rawData.filter(item => item.week === val);
        }
        
        // ğŸŒŸ äº‚æ•¸å‡ºé¡Œï¼šæ¯æ¬¡åˆ‡æ› Level éƒ½æ´—ç‰Œ
        currentLevelWords = shuffleArray(currentLevelWords);

        currentWordIndex = 0;
        loadWord(0);
        renderWordList(); // æ›´æ–°åˆ—è¡¨
    }

    function initVoiceSystem() {
        const voiceSelect = document.getElementById('voiceSelect');
        
        const populateVoices = () => {
            voices = synth.getVoices();
            if (voices.length === 0) {
                voiceSelect.innerHTML = '<option value="">ç­‰å¾…èªéŸ³è¼‰å…¥...</option>';
                return;
            }

            voiceSelect.innerHTML = '';
            let bestVoiceIndex = 0; 
            let bestPriority = 0;

            voices.forEach((voice, index) => {
                let option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = index;
                voiceSelect.appendChild(option);

                let currentPriority = 0;
                if (voice.lang.startsWith('en')) {
                    currentPriority = 1;
                    if (voice.lang === 'en-US' || voice.lang === 'en_US') currentPriority += 2;
                    if (voice.name.includes('Siri')) currentPriority += 10;
                    else if (voice.name === 'Samantha') currentPriority += 9;
                    else if (voice.name === 'Aaron') currentPriority += 8;
                    else if (voice.name.includes('Google US English')) currentPriority += 7;
                }

                if (currentPriority > bestPriority) {
                    bestPriority = currentPriority;
                    bestVoiceIndex = index;
                }
            });

            if (voices.length > 0) voiceSelect.selectedIndex = bestVoiceIndex;
        };

        if (speechSynthesis.onvoiceschanged !== undefined) {
             speechSynthesis.onvoiceschanged = populateVoices;
        }
        populateVoices();
        setTimeout(populateVoices, 500);
        setTimeout(populateVoices, 1000);
    }

    function speakText(text) {
        if (!text) return;
        synth.cancel();
        const utterThis = new SpeechSynthesisUtterance(text);
        const voiceSelect = document.getElementById('voiceSelect');
        if (voices.length > 0 && voiceSelect.value) {
            utterThis.voice = voices[voiceSelect.value];
        }
        utterThis.rate = 0.85;
        synth.speak(utterThis);
    }

    // --- âŒ¨ï¸ è™›æ“¬éµç›¤é‚è¼¯ ---
    function initKeyboard() {
        const keyboardContainer = document.getElementById('virtualKeyboard');
        const rows = [
            ["q","w","e","r","t","y","u","i","o","p"],
            ["a","s","d","f","g","h","j","k","l"],
            ["z","x","c","v","b","n","m", "'"]
        ];

        rows.forEach(rowKeys => {
            let rowDiv = document.createElement('div');
            rowDiv.className = 'keyboard-row';
            rowKeys.forEach(char => {
                let btn = document.createElement('button');
                btn.className = 'key-btn';
                btn.innerText = char;
                btn.onclick = () => typeKey(char);
                rowDiv.appendChild(btn);
            });
            keyboardContainer.appendChild(rowDiv);
        });

        let funcRow = document.createElement('div');
        funcRow.className = 'keyboard-row';
        
        let spaceBtn = document.createElement('button');
        spaceBtn.className = 'key-btn key-special key-space';
        spaceBtn.innerText = 'Space (ç©ºç™½)';
        spaceBtn.onclick = () => typeKey(' ');
        funcRow.appendChild(spaceBtn);

        let backBtn = document.createElement('button');
        backBtn.className = 'key-btn key-special';
        backBtn.innerText = 'âŒ«';
        backBtn.onclick = () => backspaceKey();
        funcRow.appendChild(backBtn);

        keyboardContainer.appendChild(funcRow);
    }

    function typeKey(char) {
        const input = document.getElementById('dictationInput');
        input.value += char;
        input.focus();
    }

    function backspaceKey() {
        const input = document.getElementById('dictationInput');
        input.value = input.value.slice(0, -1);
        input.focus();
    }

    // --- 4. æ ¸å¿ƒé‚è¼¯ ---
    function loadWord(index) {
        if (index >= currentLevelWords.length) index = 0;
        if (index < 0) index = currentLevelWords.length - 1; // å¾ªç’°è™•ç†
        
        currentWordIndex = index;
        currentWordObj = currentLevelWords[index];

        document.getElementById('feedbackB').innerText = "";
        document.getElementById('feedbackC').innerText = "";
        
        document.getElementById('dictationInput').value = "";

        // Mode A
        renderColoredWord(currentWordObj);
        document.getElementById('chineseDisplay').innerText = currentWordObj.chinese;
        document.getElementById('exampleDisplay').innerText = currentWordObj.example;
        document.getElementById('syllableBox').innerText = currentWordObj.syllables.join(" - ");
        updateSyllableVisibility();

        // Mode B & C Text
        document.getElementById('chineseHintB').innerText = currentWordObj.chinese;
        document.getElementById('chineseHintC').innerText = currentWordObj.chinese;

        // Mode B Setup
        initPuzzleMode(currentWordObj.word);

        // Update List Highlight (å¦‚æœå–®å­—è¡¨æ˜¯é–‹å•Ÿçš„)
        updateListHighlight();
    }

    // --- ä¸Š/ä¸‹ä¸€å€‹å–®å­—åŠŸèƒ½ ---
    function nextWord() {
        let nextIndex = currentWordIndex + 1;
        if (nextIndex >= currentLevelWords.length) nextIndex = 0;
        loadWord(nextIndex);
        speakText(currentWordObj.word);
    }

    function prevWord() {
        let prevIndex = currentWordIndex - 1;
        if (prevIndex < 0) prevIndex = currentLevelWords.length - 1;
        loadWord(prevIndex);
        speakText(currentWordObj.word);
    }

    function switchTab(modeId) {
        document.querySelectorAll('.mode-section').forEach(el => el.classList.remove('active'));
        document.getElementById(modeId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- Mode List (å–®å­—ç¸½è¦½) æ¸²æŸ“é‚è¼¯ ---
    function renderWordList() {
        const listContainer = document.getElementById('fullWordList');
        listContainer.innerHTML = '';
        currentLevelWords.forEach((item, index) => {
            let btn = document.createElement('button');
            btn.className = 'list-btn';
            btn.innerText = item.word;
            btn.id = `list-btn-${index}`;
            btn.onclick = () => {
                loadWord(index);
                switchTab('modeA');
                speakText(item.word);
            };
            listContainer.appendChild(btn);
        });
        updateListHighlight();
    }

    function updateListHighlight() {
        // ç§»é™¤æ‰€æœ‰ highlight
        document.querySelectorAll('.list-btn').forEach(btn => btn.classList.remove('active-word'));
        // åŠ å…¥ç•¶å‰å–®å­—çš„ highlight
        const currentBtn = document.getElementById(`list-btn-${currentWordIndex}`);
        if (currentBtn) currentBtn.classList.add('active-word');
    }

    function renderColoredWord(wordObj) {
        const display = document.getElementById('wordDisplay');
        display.innerHTML = '';
        const vowels = ['a','e','i','o','u'];
        const word = wordObj.word;
        const irregulars = wordObj.irregularIndices || [];

        for (let i = 0; i < word.length; i++) {
            let char = word[i];
            let span = document.createElement('span');
            span.innerText = char;

            // ğŸŒŸ åˆ¤æ–·æ˜¯å¦ç‚ºå­—æ¯ (regex)
            const isLetter = /[a-zA-Z]/.test(char);

            if (char === ' ') {
                span.style.width = "15px";
                span.style.display = "inline-block";
            } else if (!isLetter) {
                // ğŸŒŸ éå­—æ¯ (å¦‚ ') è¨­ç‚ºç°è‰²
                span.className = 'char-symbol';
            } else if (irregulars.includes(i)) {
                span.className = 'char-irregular';
            } else if (vowels.includes(char.toLowerCase())) {
                span.className = 'char-vowel';
            } else {
                span.className = 'char-consonant';
            }
            display.appendChild(span);
        }
    }

    function toggleSyllables() {
        isSyllableVisible = !isSyllableVisible;
        updateSyllableVisibility();
    }

    function updateSyllableVisibility() {
        const box = document.getElementById('syllableBox');
        const btn = document.getElementById('btnToggleSyllable');
        if (isSyllableVisible) {
            box.style.display = 'inline-block';
            btn.innerText = 'éš±è—éŸ³ç¯€';
        } else {
            box.style.display = 'none';
            btn.innerText = 'é¡¯ç¤ºéŸ³ç¯€';
        }
    }

    // --- Mode B: ç©æœ¨é‚è¼¯ ---
    let puzzleCurrentAnswer = [];
    function initPuzzleMode(word) {
        const container = document.getElementById('puzzlePieces');
        const answerArea = document.getElementById('puzzleAnswer');
        container.innerHTML = '';
        answerArea.innerHTML = '';
        puzzleCurrentAnswer = [];

        let letters = word.split('').sort(() => Math.random() - 0.5);

        letters.forEach((char) => {
            let btn = document.createElement('div');
            btn.className = 'letter-block';
            
            if (char === ' ') {
                btn.classList.add('space-block');
                btn.innerText = '_';
            } else {
                btn.innerText = char;
            }

            btn.onclick = () => {
                let ansSpan = document.createElement('span');
                ansSpan.innerText = char === ' ' ? ' ' : char;
                if (char === ' ') ansSpan.style.width = '20px';
                
                answerArea.appendChild(ansSpan);
                puzzleCurrentAnswer.push(char);
                btn.style.visibility = 'hidden';
                checkPuzzle(word);
            };
            container.appendChild(btn);
        });
    }

    function resetPuzzle() {
        initPuzzleMode(currentWordObj.word);
        document.getElementById('feedbackB').innerText = "";
    }

    function checkPuzzle(correctWord) {
        const userWord = puzzleCurrentAnswer.join('');
        if (userWord.length === correctWord.length) {
            const feedback = document.getElementById('feedbackB');
            if (userWord === correctWord) {
                feedback.innerHTML = "<span class='correct'>ğŸ‰ ç­”å°äº†ï¼</span>";
                playSound('correct'); 
                speakText(correctWord);
            } else {
                feedback.innerHTML = "<span class='wrong'>âŒ å†è©¦ä¸€æ¬¡ï¼</span>";
                playSound('wrong'); 
            }
        }
    }

    // --- Mode C: è½å¯«é‚è¼¯ ---
    function checkDictation() {
        const input = document.getElementById('dictationInput');
        const feedback = document.getElementById('feedbackC');
        
        if (input.value.trim().toLowerCase() === currentWordObj.word.toLowerCase()) {
            feedback.innerHTML = "<span class='correct'>ğŸŒŸ å®Œå…¨æ­£ç¢ºï¼</span>";
            playSound('correct'); 
            speakText(currentWordObj.word);
        } else {
            feedback.innerHTML = `<span class='wrong'>âŒ æ­£ç¢ºæ˜¯ï¼š${currentWordObj.word}</span>`;
            playSound('wrong'); 
        }
    }

    function resetDictation() {
        const input = document.getElementById('dictationInput');
        const feedback = document.getElementById('feedbackC');
        input.value = ""; 
        feedback.innerText = ""; 
        input.focus(); 
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…’ç«¥è‹±æ–‡æ‹¼å­—å­¸ç¿’æ©Ÿ (Pro Plus) ğŸ</title>
    <style>
        /* --- ğŸ¨ è¦–è¦ºè¨­è¨ˆ --- */
        :root {
            --primary-yellow: #FFD700;
            --primary-blue: #40E0D0;
            --text-dark: #2C3E50;
            --bg-color: #F7F9FC;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.1);
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            
            /* æ–‡å­—é¡è‰²å®šç¾© */
            --color-vowel: #FF4500;      /* ç´…è‰²ï¼šçŸ­æ¯éŸ³/ä¸€èˆ¬æ¯éŸ³ */
            --color-consonant: #1E90FF;  /* è—è‰²ï¼šå­éŸ³ */
            --color-irregular: #9932CC;  /* ç´«è‰²ï¼šä¸è¦å‰‡/é•·æ¯éŸ³/ç‰¹æ®Šç™¼éŸ³/ä¸ç™¼éŸ³å­—æ¯ */
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
            text-align: center;
        }

        h1 {
            color: #FF8C00;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px #FFE4B5;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: 5px solid var(--primary-yellow);
        }

        /* --- ğŸ›ï¸ æ§åˆ¶åˆ— --- */
        .controls-bar {
            background-color: #E0F7FA;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        select {
            padding: 10px 15px;
            font-size: 1rem;
            border-radius: 10px;
            border: 2px solid var(--primary-blue);
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        label { font-weight: bold; color: #00796B; }

        /* --- ğŸ“‘ åˆ†é ç±¤ --- */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #ddd;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 4px solid transparent;
            margin-bottom: -3px;
        }

        .tab-btn:hover { color: var(--primary-blue); }
        .tab-btn.active {
            color: var(--text-dark);
            border-bottom: 4px solid var(--primary-yellow);
        }

        /* --- ğŸ« å­¸ç¿’å€åŸŸ --- */
        .mode-section {
            display: none;
            animation: fadeIn 0.5s;
        }
        .mode-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .word-card {
            padding: 30px;
            background: #FFF9C4;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .big-word {
            font-size: 4rem;
            font-weight: bold;
            margin: 10px 0;
            letter-spacing: 2px;
        }

        /* å­—å…ƒé¡è‰²æ¨£å¼ */
        .char-vowel { color: var(--color-vowel); }
        .char-consonant { color: var(--color-consonant); }
        .char-irregular { color: var(--color-irregular); font-weight: 900; text-shadow: 1px 1px 0px #eee; }

        .info-text {
            font-size: 1.5rem;
            margin: 10px 0;
            color: #555;
        }
        
        .example-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .example-text {
            font-style: italic;
            color: #555;
            font-size: 1.2rem;
        }

        /* ä¾‹å¥æ’­æ”¾æŒ‰éˆ• */
        .btn-sm-speak {
            background: #FF6B6B;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .btn-sm-speak:active { transform: scale(0.9); }

        .syllable-box {
            background: white;
            display: block; /* é è¨­é¡¯ç¤º */
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px dashed #aaa;
            margin: 15px auto;
            font-size: 1.2rem;
            color: #666;
            width: fit-content;
        }

        /* --- ğŸ® äº’å‹•æŒ‰éˆ• --- */
        button.action-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #008B8B;
            transition: transform 0.1s;
            margin: 5px;
        }
        button.action-btn:active { transform: translateY(4px); box-shadow: none; }
        button.secondary-btn { background-color: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; }
        button.speak-btn { background-color: #FF8C00; box-shadow: 0 4px 0 #D2691E; font-size: 1.5rem; padding: 15px 30px; }

        /* --- ğŸ§© ç©æœ¨èˆ‡è½å¯« --- */
        .letter-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            min-height: 60px;
        }
        .letter-block {
            background: white;
            border: 3px solid var(--primary-yellow);
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 0 #ccc;
            user-select: none;
        }
        .answer-area {
            min-height: 60px;
            border-bottom: 4px solid #333;
            margin: 0 20px;
            display: flex;
            justify-content: center;
            gap: 5px;
            font-size: 3rem;
            font-family: monospace;
        }
        input[type="text"] {
            font-size: 2rem;
            padding: 10px;
            width: 80%;
            text-align: center;
            border: 3px solid var(--primary-blue);
            border-radius: 15px;
            outline: none;
        }
        .feedback-msg {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 15px;
            min-height: 1.5em;
        }
        .correct { color: #2ecc71; }
        .wrong { color: #e74c3c; }

        @media (max-width: 600px) {
            .big-word { font-size: 3rem; }
            .controls-bar { flex-direction: column; }
            select { width: 100%; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1>ğŸ æ‹¼å­—å°èœœèœ‚ Pro+</h1>

    <!-- æ§åˆ¶å€ -->
    <div class="controls-bar">
        <div>
            <label>ğŸ“š ç­‰ç´šï¼š</label>
            <select id="levelSelect" onchange="changeLevel()"></select>
        </div>
        <div>
            <label>ğŸ—£ï¸ ç™¼éŸ³ï¼š</label>
            <select id="voiceSelect">
                <option value="">æ­£åœ¨è¼‰å…¥èªéŸ³...</option>
            </select>
        </div>
    </div>

    <!-- é ç±¤ -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('modeA')">ğŸ‘€ çœ‹å–®å­— (å­¸ç¿’)</button>
        <button class="tab-btn" onclick="switchTab('modeB')">ğŸ§© æ‹¼ç©æœ¨ (ç·´ç¿’)</button>
        <button class="tab-btn" onclick="switchTab('modeC')">ğŸ“ è½å¯«è€ƒ (æ¸¬é©—)</button>
    </div>

    <!-- æ¨¡å¼ Aï¼šå­¸ç¿’å¡ -->
    <div id="modeA" class="mode-section active">
        <div class="word-card">
            <button class="action-btn speak-btn" onclick="speakText(currentWordObj.word)">ğŸ”Š å–®å­—ç™¼éŸ³</button>
            
            <div id="wordDisplay" class="big-word"></div>
            
            <div id="chineseDisplay" class="info-text"></div>
            
            <!-- ä¾‹å¥å€å¡Š (å«æ’­æ”¾æŒ‰éˆ•) -->
            <div class="example-container">
                <div id="exampleDisplay" class="example-text"></div>
                <button class="btn-sm-speak" onclick="speakText(currentWordObj.example)" title="æœ—è®€ä¾‹å¥">ğŸ”ˆ</button>
            </div>
            
            <!-- éŸ³ç¯€é¡¯ç¤º (é è¨­é–‹å•Ÿ) -->
            <div id="syllableBox" class="syllable-box"></div>
            <div style="margin-top: 10px;">
                <button id="btnToggleSyllable" class="action-btn secondary-btn" style="font-size: 1rem; padding: 8px 16px;" onclick="toggleSyllables()">éš±è—éŸ³ç¯€</button>
            </div>
        </div>
        <button class="action-btn" onclick="nextWord()">â¡ï¸ ä¸‹ä¸€å€‹å–®å­—</button>
    </div>

    <!-- æ¨¡å¼ Bï¼šç©æœ¨é‡çµ„ -->
    <div id="modeB" class="mode-section">
        <div class="word-card">
            <button class="action-btn speak-btn" onclick="speakText(currentWordObj.word)">ğŸ”Š æ’­è²éŸ³</button>
            <div class="info-text" id="chineseHintB"></div>
            
            <div id="puzzleAnswer" class="answer-area"></div>
            <div id="puzzlePieces" class="letter-container"></div>
            <div id="feedbackB" class="feedback-msg"></div>
        </div>
        <button class="action-btn secondary-btn" onclick="resetPuzzle()">ğŸ”„ é‡ç½®</button>
        <button class="action-btn" onclick="nextWord()">â¡ï¸ ä¸‹ä¸€å€‹å–®å­—</button>
    </div>

    <!-- æ¨¡å¼ Cï¼šè½å¯« -->
    <div id="modeC" class="mode-section">
        <div class="word-card">
            <button class="action-btn speak-btn" onclick="speakText(currentWordObj.word)">ğŸ”Š æ’­è²éŸ³</button>
            <div class="info-text" id="chineseHintC"></div>
            
            <input type="text" id="dictationInput" placeholder="è¼¸å…¥å–®å­—..." autocomplete="off">
            <div id="feedbackC" class="feedback-msg"></div>
        </div>
        <button class="action-btn secondary-btn" onclick="checkDictation()">âœ… æª¢æŸ¥ç­”æ¡ˆ</button>
        <button class="action-btn" onclick="nextWord()">â¡ï¸ ä¸‹ä¸€å€‹å–®å­—</button>
    </div>

</div>

<script>
    // --- 1. è³‡æ–™ä¾†æº (Data Source) ---
    // irregularIndices: æ¨™ç¤ºç‚ºç´«è‰²çš„ç´¢å¼•ä½ç½® (å¾ 0 é–‹å§‹)
    // åŒ…å«è¦å‰‡ï¼šR-controlled, Vowel Teams, Long Vowels, Silent Letters
    const rawData = [
        // --- åŸå§‹å–®å­— ---
        { word: "cube", syllables: ["cube"], chinese: "ç«‹æ–¹é«”", example: "The toy is shaped like a cube.", irregularIndices: [1, 3] },
        { word: "cute", syllables: ["cute"], chinese: "å¯æ„›çš„", example: "The puppy is very cute.", irregularIndices: [1, 3] },
        { word: "mule", syllables: ["mule"], chinese: "é¨¾å­", example: "The farmer uses a mule to carry supplies.", irregularIndices: [1, 3] },
        { word: "flute", syllables: ["flute"], chinese: "é•·ç¬›", example: "She plays the flute every day.", irregularIndices: [2, 4] },
        { word: "ruler", syllables: ["ru", "ler"], chinese: "å°ºï¼›çµ±æ²»è€…", example: "Please use a ruler to draw a straight line.", irregularIndices: [1] },
        { word: "tube", syllables: ["tube"], chinese: "ç®¡å­", example: "Water flows through the tube.", irregularIndices: [1, 3] },
        { word: "tune", syllables: ["tune"], chinese: "æ—‹å¾‹ï¼›èª¿éŸ³", example: "This tune is easy to sing.", irregularIndices: [1, 3] },
        { word: "again", syllables: ["a", "gain"], chinese: "å†æ¬¡", example: "Please try again.", irregularIndices: [2, 3] },
        { word: "cold", syllables: ["cold"], chinese: "å†·çš„", example: "The water is very cold.", irregularIndices: [1] },
        { word: "hot", syllables: ["hot"], chinese: "ç†±çš„", example: "Be careful, the soup is hot.", irregularIndices: [] },
        { word: "where", syllables: ["where"], chinese: "åœ¨å“ªè£¡", example: "Where are you going?", irregularIndices: [2, 4] },
        { word: "went", syllables: ["went"], chinese: "å»ï¼ˆgo çš„éå»å¼ï¼‰", example: "She went to school early.", irregularIndices: [] },
        { word: "away", syllables: ["a", "way"], chinese: "é›¢é–‹ï¼›é è™•", example: "The bird flew away.", irregularIndices: [2, 3] },
        { word: "take", syllables: ["take"], chinese: "æ‹¿ï¼›å¸¶èµ°", example: "Please take your bag with you.", irregularIndices: [1, 3] },
        { word: "night", syllables: ["night"], chinese: "å¤œæ™š", example: "The stars are bright at night.", irregularIndices: [1, 2, 3] },
        { word: "at", syllables: ["at"], chinese: "åœ¨â€¦", example: "She is at home.", irregularIndices: [] },
        { word: "they", syllables: ["they"], chinese: "ä»–å€‘", example: "They are playing outside.", irregularIndices: [2, 3] },
        { word: "me", syllables: ["me"], chinese: "æˆ‘ï¼ˆå—æ ¼ï¼‰", example: "Please give the book to me.", irregularIndices: [1] },
        
        // --- æ–°å¢å–®å­— (å·²åŠ å…¥ç™¼éŸ³è¦å‰‡åˆ†æ) ---
        { word: "across", syllables: ["a", "cross"], chinese: "ç©¿éï¼›æ©«è¶Š", example: "He walked across the street.", irregularIndices: [0] }, // a (schwa)
        { word: "around", syllables: ["a", "round"], chinese: "åˆ°è™•", example: "Kids were running around in the playground.", irregularIndices: [0, 2, 3] }, // a (schwa), ou (diphthong)
        { word: "belong", syllables: ["be", "long"], chinese: "å±¬æ–¼", example: "This book belongs to me.", irregularIndices: [1] }, // e (long)
        { word: "boxer", syllables: ["box", "er"], chinese: "æ‹³æ“Šæ‰‹", example: "The boxer trained hard every day.", irregularIndices: [3, 4] }, // er (r-controlled)
        { word: "creep", syllables: ["creep"], chinese: "æ‚„æ‚„ç§»å‹•ï¼›çˆ¬è¡Œ", example: "The spider crept along the wall.", irregularIndices: [2, 3] }, // ee (vowel team)
        { word: "afternoon", syllables: ["af", "ter", "noon"], chinese: "ä¸‹åˆ", example: "We meet in the afternoon.", irregularIndices: [3, 4, 6, 7] }, // er, oo
        { word: "baboon", syllables: ["ba", "boon"], chinese: "ç‹’ç‹’", example: "A baboon jumped onto the rock.", irregularIndices: [1, 3, 4] }, // a (schwa), oo
        { word: "beyond", syllables: ["be", "yond"], chinese: "åœ¨â€¦ä¹‹å¤–ï¼›åœ¨æ›´é è™•", example: "The mountains are beyond the river.", irregularIndices: [1] }, // e (long)
        { word: "bully", syllables: ["bul", "ly"], chinese: "æƒ¡éœ¸", example: "A bully was picking on smaller kids.", irregularIndices: [4] }, // y (long e sound)
        { word: "cricket", syllables: ["crick", "et"], chinese: "æ¿çƒï¼›èŸ‹èŸ€", example: "A cricket is chirping outside.", irregularIndices: [] }, // regular short vowels mostly
        { word: "airport", syllables: ["air", "port"], chinese: "æ©Ÿå ´", example: "We arrived at the airport early.", irregularIndices: [0, 1, 2, 4, 5] }, // air, or
        { word: "baseball", syllables: ["base", "ball"], chinese: "æ£’çƒ", example: "He plays baseball on weekends.", irregularIndices: [1, 3, 5] }, // a (long), e (silent), a (all)
        { word: "blood", syllables: ["blood"], chinese: "è¡€æ¶²", example: "Blood carries oxygen through the body.", irregularIndices: [2, 3] }, // oo (short u - irregular)
        { word: "circus", syllables: ["cir", "cus"], chinese: "é¦¬æˆ²åœ˜", example: "We watched a circus show yesterday.", irregularIndices: [1, 2] }, // ir (r-controlled)
        { word: "dairy", syllables: ["dai", "ry"], chinese: "ä¹³è£½å“ï¼›ä¹³å“åº—", example: "She avoids dairy because of allergies.", irregularIndices: [1, 2, 4] }, // ai, y
        { word: "alligator", syllables: ["al", "li", "ga", "tor"], chinese: "çŸ­å»é±·", example: "An alligator lives in the swamp.", irregularIndices: [6, 8] }, // a (long), or (schwa/r)
        { word: "become", syllables: ["be", "come"], chinese: "æˆç‚º", example: "He wants to become a pilot.", irregularIndices: [1, 3, 5] }, // e, o (schwa), e (silent)
        { word: "boom", syllables: ["boom"], chinese: "ç¹æ¦®ï¼›è½Ÿéš†è²", example: "There was a boom in construction.", irregularIndices: [1, 2] }, // oo
        { word: "claw", syllables: ["claw"], chinese: "çˆªå­", example: "The cat scratched the tree with its claw.", irregularIndices: [2, 3] }, // aw
        { word: "desert", syllables: ["des", "ert"], chinese: "æ²™æ¼ ", example: "Camels live in the desert.", irregularIndices: [3, 4] }, // er
        { word: "another", syllables: ["a", "no", "ther"], chinese: "å¦ä¸€å€‹", example: "He took another cookie.", irregularIndices: [0, 2, 5, 6] }, // a, o, er
        { word: "beetle", syllables: ["bee", "tle"], chinese: "ç”²èŸ²", example: "A beetle crawled on the leaf.", irregularIndices: [1, 2, 5] }, // ee, e(silent)
        { word: "bottom", syllables: ["bot", "tom"], chinese: "åº•éƒ¨", example: "The treasure is at the bottom of the sea.", irregularIndices: [4] }, // o (schwa)
        { word: "cobra", syllables: ["co", "bra"], chinese: "çœ¼é¡è›‡", example: "A cobra raised its hood.", irregularIndices: [1, 4] }, // o (long), a (schwa)
        { word: "drown", syllables: ["drown"], chinese: "æººæ­»ï¼›æ·¹æ²’", example: "Be careful not to drown in deep water.", irregularIndices: [2, 3] }, // ow
        { word: "dumb", syllables: ["dumb"], chinese: "ç¬¨çš„ï¼›ç„¡è¨€çš„", example: "That was a dumb mistake.", irregularIndices: [3] }, // b (silent)
        { word: "flake", syllables: ["flake"], chinese: "è–„ç‰‡ï¼›å‰è½", example: "Snowflakes fell from the sky.", irregularIndices: [2, 4] }, // a (long), e (silent)
        { word: "guide", syllables: ["guide"], chinese: "å¼•å°ï¼›å°éŠ", example: "The guide showed us the way.", irregularIndices: [1, 2, 4] }, // ui (long i), e (silent)
        { word: "honor", syllables: ["hon", "or"], chinese: "æ¦®è­½ï¼›å°Šæ•¬", example: "It is an honor to meet you.", irregularIndices: [0, 3, 4] }, // h (silent), or (schwa)
        { word: "lack", syllables: ["lack"], chinese: "ç¼ºä¹", example: "They lack clean water.", irregularIndices: [] }, 
        { word: "during", syllables: ["dur", "ing"], chinese: "åœ¨â€¦æœŸé–“", example: "Do not talk during the movie.", irregularIndices: [1] }, // u (long/yoo)
        { word: "forest", syllables: ["for", "est"], chinese: "æ£®æ—", example: "We hiked through the forest.", irregularIndices: [1, 2] }, // or
        { word: "guitar", syllables: ["gui", "tar"], chinese: "å‰ä»–", example: "She plays the guitar well.", irregularIndices: [1, 2, 4, 5] }, // ui (silent u), ar
        { word: "hoof", syllables: ["hoof"], chinese: "è¹„", example: "A horse has four hooves.", irregularIndices: [1, 2] }, // oo
        { word: "lift", syllables: ["lift"], chinese: "æŠ¬èµ·ï¼›æå‡", example: "Please help me lift the box.", irregularIndices: [] }, 
        { word: "eagle", syllables: ["ea", "gle"], chinese: "è€é·¹", example: "An eagle flew overhead.", irregularIndices: [0, 1, 4] }, // ea, e
        { word: "fuss", syllables: ["fuss"], chinese: "å¤§é©šå°æ€ªï¼›å¿™äº‚", example: "Donâ€™t make a fuss over nothing.", irregularIndices: [] },
        { word: "gym", syllables: ["gym"], chinese: "é«”è‚²é¤¨ï¼›å¥èº«æˆ¿", example: "He works out at the gym.", irregularIndices: [1] }, // y (short i)
        { word: "huge", syllables: ["huge"], chinese: "å·¨å¤§çš„", example: "The elephant is huge.", irregularIndices: [1, 3] }, // u (long), e
        { word: "lizard", syllables: ["liz", "ard"], chinese: "èœ¥èœ´", example: "A lizard ran across the rock.", irregularIndices: [3, 4] }, // ar (schwa)
        { word: "earth", syllables: ["earth"], chinese: "åœ°çƒï¼›åœŸåœ°", example: "The Earth rotates around the sun.", irregularIndices: [0, 1, 2] }, // ear
        { word: "gear", syllables: ["gear"], chinese: "é½’è¼ªï¼›è£å‚™", example: "He packed his camping gear.", irregularIndices: [1, 2, 3] }, // ear
        { word: "half", syllables: ["half"], chinese: "ä¸€åŠ", example: "I ate half of the cake.", irregularIndices: [2] }, // l (silent)
        { word: "interest", syllables: ["in", "ter", "est"], chinese: "èˆˆè¶£ï¼›åˆ©ç›Š", example: "This book caught my interest.", irregularIndices: [3, 4] }, // er
        { word: "magic", syllables: ["ma", "gic"], chinese: "é­”æ³•ï¼›ç¥å¥‡", example: "He performed a magic trick.", irregularIndices: [] }, 
        { word: "feast", syllables: ["feast"], chinese: "ç››å®´", example: "They prepared a big feast.", irregularIndices: [1, 2] }, // ea
        { word: "gorilla", syllables: ["go", "ril", "la"], chinese: "å¤§çŒ©çŒ©", example: "A gorilla sat under the tree.", irregularIndices: [1, 6] }, // o (schwa), a (schwa)
        { word: "honk", syllables: ["honk"], chinese: "æŒ‰å–‡å­ï¼›é›å«è²", example: "He honked the car horn.", irregularIndices: [] }, 
        { word: "karate", syllables: ["ka", "ra", "te"], chinese: "ç©ºæ‰‹é“", example: "She practices karate every week.", irregularIndices: [1, 5] }, // a (schwa), e (long/ay)
        { word: "manner", syllables: ["man", "ner"], chinese: "æ–¹å¼ï¼›ç¦®è²Œ", example: "He has good manners at the table.", irregularIndices: [4, 5] } // er
    ];

    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentLevelWords = [];
    let currentWordIndex = 0;
    let currentWordObj = null;
    let voices = [];
    let synth = window.speechSynthesis;
    let isSyllableVisible = true; // é è¨­é¡¯ç¤ºéŸ³ç¯€

    // --- 2. åˆå§‹åŒ–èˆ‡è¨­å®š ---
    window.onload = function() {
        initLevelSystem();
        initVoiceSystem();
        loadWord(0);
    };

    function initLevelSystem() {
        const levelSelect = document.getElementById('levelSelect');
        const totalWords = rawData.length;
        const levelSize = 10;
        const totalLevels = Math.ceil(totalWords / levelSize);

        for (let i = 0; i < totalLevels; i++) {
            let option = document.createElement('option');
            option.value = i;
            option.text = `Level ${i + 1} (${i * levelSize + 1} - ${Math.min((i + 1) * levelSize, totalWords)})`;
            levelSelect.appendChild(option);
        }
        
        let allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.text = "å…¨éƒ¨å–®å­— (All)";
        levelSelect.appendChild(allOption);

        changeLevel();
    }

    function changeLevel() {
        const val = document.getElementById('levelSelect').value;
        if (val === 'all') {
            currentLevelWords = [...rawData];
        } else {
            const levelIndex = parseInt(val);
            const start = levelIndex * 10;
            const end = start + 10;
            currentLevelWords = rawData.slice(start, end);
        }
        currentWordIndex = 0;
        loadWord(0);
    }

    function initVoiceSystem() {
        const populateVoices = () => {
            voices = synth.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            if (voices.length === 0) return;

            voiceSelect.innerHTML = ''; 
            let defaultIndex = 0;
            voices.forEach((voice, index) => {
                let option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = index;
                voiceSelect.appendChild(option);

                if (voice.name.includes('Google US English')) defaultIndex = index;
                else if (voice.lang === 'en-US' && defaultIndex === 0) defaultIndex = index;
            });
            voiceSelect.selectedIndex = defaultIndex;
        };

        populateVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoices;
        }
        setTimeout(() => { if(document.getElementById('voiceSelect').length <= 1) populateVoices(); }, 1000);
    }

    // çµ±ä¸€ç™¼éŸ³å‡½å¼ï¼šå¯ç™¼éŸ³å–®å­—æˆ–ä¾‹å¥
    function speakText(text) {
        if (!text) return;
        
        // å–æ¶ˆä¹‹å‰çš„ç™¼éŸ³
        synth.cancel();

        const utterThis = new SpeechSynthesisUtterance(text);
        const voiceSelect = document.getElementById('voiceSelect');
        
        if (voices.length > 0 && voiceSelect.value) {
            utterThis.voice = voices[voiceSelect.value];
        }

        utterThis.rate = 0.85; // é©ä¸­èªé€Ÿ
        synth.speak(utterThis);
    }

    // --- 3. æ ¸å¿ƒé‚è¼¯ ---
    function loadWord(index) {
        if (index >= currentLevelWords.length) index = 0;
        currentWordIndex = index;
        currentWordObj = currentLevelWords[index];

        // é‡ç½® UI
        document.getElementById('feedbackB').innerText = "";
        document.getElementById('feedbackC').innerText = "";
        document.getElementById('dictationInput').value = "";

        // Mode A
        renderColoredWord(currentWordObj);
        document.getElementById('chineseDisplay').innerText = currentWordObj.chinese;
        document.getElementById('exampleDisplay').innerText = currentWordObj.example;
        document.getElementById('syllableBox').innerText = currentWordObj.syllables.join(" - ");
        
        // éŸ³ç¯€é¡¯ç¤ºç‹€æ…‹ç¶­æŒ
        updateSyllableVisibility();

        // Mode B & C Text
        document.getElementById('chineseHintB').innerText = currentWordObj.chinese;
        document.getElementById('chineseHintC').innerText = currentWordObj.chinese;

        // Mode B Setup
        initPuzzleMode(currentWordObj.word);
    }

    function nextWord() {
        currentWordIndex++;
        if (currentWordIndex >= currentLevelWords.length) currentWordIndex = 0;
        loadWord(currentWordIndex);
        speakText(currentWordObj.word);
    }

    function switchTab(modeId) {
        document.querySelectorAll('.mode-section').forEach(el => el.classList.remove('active'));
        document.getElementById(modeId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- æ¸²æŸ“é¡è‰²é‚è¼¯ ---
    function renderColoredWord(wordObj) {
        const display = document.getElementById('wordDisplay');
        display.innerHTML = '';
        const vowels = ['a','e','i','o','u'];
        const word = wordObj.word;
        const irregulars = wordObj.irregularIndices || []; // å–å¾—ç´«è‰²æ¨™è¨˜æ¸…å–®

        for (let i = 0; i < word.length; i++) {
            let char = word[i];
            let span = document.createElement('span');
            span.innerText = char;

            // å„ªå…ˆæª¢æŸ¥ï¼šæ˜¯å¦åœ¨ç‰¹æ®Šæ¨™è¨˜æ¸…å–®ä¸­ï¼Ÿ -> ç´«è‰²
            if (irregulars.includes(i)) {
                span.className = 'char-irregular';
            } 
            // å…¶æ¬¡æª¢æŸ¥ï¼šæ˜¯å¦ç‚ºæ¯éŸ³ï¼Ÿ -> ç´…è‰²
            else if (vowels.includes(char.toLowerCase())) {
                span.className = 'char-vowel';
            } 
            // å‰©ä¸‹ï¼šå­éŸ³ -> è—è‰²
            else {
                span.className = 'char-consonant';
            }
            display.appendChild(span);
        }
    }

    // --- éŸ³ç¯€é–‹é—œé‚è¼¯ ---
    function toggleSyllables() {
        isSyllableVisible = !isSyllableVisible;
        updateSyllableVisibility();
    }

    function updateSyllableVisibility() {
        const box = document.getElementById('syllableBox');
        const btn = document.getElementById('btnToggleSyllable');
        if (isSyllableVisible) {
            box.style.display = 'inline-block';
            btn.innerText = 'éš±è—éŸ³ç¯€';
        } else {
            box.style.display = 'none';
            btn.innerText = 'é¡¯ç¤ºéŸ³ç¯€';
        }
    }

    // --- Mode B: ç©æœ¨é‚è¼¯ ---
    let puzzleCurrentAnswer = [];
    function initPuzzleMode(word) {
        const container = document.getElementById('puzzlePieces');
        const answerArea = document.getElementById('puzzleAnswer');
        container.innerHTML = '';
        answerArea.innerHTML = '';
        puzzleCurrentAnswer = [];

        let letters = word.split('').sort(() => Math.random() - 0.5);

        letters.forEach((char) => {
            let btn = document.createElement('div');
            btn.className = 'letter-block';
            btn.innerText = char;
            btn.onclick = () => {
                let ansSpan = document.createElement('span');
                ansSpan.innerText = char;
                answerArea.appendChild(ansSpan);
                puzzleCurrentAnswer.push(char);
                btn.style.visibility = 'hidden';
                checkPuzzle(word);
            };
            container.appendChild(btn);
        });
    }

    function resetPuzzle() {
        initPuzzleMode(currentWordObj.word);
        document.getElementById('feedbackB').innerText = "";
    }

    function checkPuzzle(correctWord) {
        const userWord = puzzleCurrentAnswer.join('');
        if (userWord.length === correctWord.length) {
            const feedback = document.getElementById('feedbackB');
            if (userWord === correctWord) {
                feedback.innerHTML = "<span class='correct'>ğŸ‰ ç­”å°äº†ï¼</span>";
                speakText(correctWord);
            } else {
                feedback.innerHTML = "<span class='wrong'>âŒ å†è©¦ä¸€æ¬¡ï¼</span>";
            }
        }
    }

    // --- Mode C: è½å¯«é‚è¼¯ ---
    function checkDictation() {
        const input = document.getElementById('dictationInput');
        const feedback = document.getElementById('feedbackC');
        
        if (input.value.trim().toLowerCase() === currentWordObj.word.toLowerCase()) {
            feedback.innerHTML = "<span class='correct'>ğŸŒŸ å®Œå…¨æ­£ç¢ºï¼</span>";
            speakText(currentWordObj.word);
        } else {
            feedback.innerHTML = `<span class='wrong'>âŒ æ­£ç¢ºæ˜¯ï¼š${currentWordObj.word}</span>`;
        }
    }
</script>

</body>
</html>